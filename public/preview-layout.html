<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GainLab Layout Preview — T1/T2/T3 Components</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg0:#08081a;--bg1:#0d0d20;--bg2:#12122a;--bg3:#1a1a3e;
  --bgH:#1e1e3a;--brd:#2a2a4a;--brd2:#3a3a6a;
  --t1:#e0e0f0;--t2:#8888aa;--t3:#5a5a8a;
  --acc:#2563eb;--acc2:#1d4ed8;
  --grn:#26a69a;--red:#ef5350;--gld:#f0b90b;
}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro','Inter',system-ui,sans-serif;background:var(--bg0);color:var(--t1);height:100vh;overflow:hidden;display:flex;flex-direction:column}

/* ═══ HEADER ═══ */
.hdr{height:40px;background:var(--bg1);border-bottom:1px solid var(--brd);display:flex;align-items:center;padding:0 10px;gap:10px;flex-shrink:0;z-index:100}
.logo{font-size:14px;font-weight:700;background:linear-gradient(135deg,#60a5fa,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hsep{width:1px;height:18px;background:var(--brd)}
.pills{display:flex;gap:4px}
.pill{display:flex;align-items:center;gap:3px;padding:2px 7px;border-radius:4px;font-size:10px;font-weight:500;background:var(--bg3);color:var(--t2);cursor:pointer;border:1px solid transparent;transition:.15s}
.pill:hover{background:var(--bgH);color:var(--t1)}
.pill.on{border-color:var(--acc);color:var(--t1);background:rgba(37,99,235,.1)}
.dot{width:4px;height:4px;border-radius:50%;flex-shrink:0}
.dg{background:var(--grn);box-shadow:0 0 3px var(--grn)}.dr{background:var(--t3)}
.spc{flex:1}
/* (ticker removed) */
.hb{padding:3px 8px;border-radius:5px;font-size:11px;font-weight:500;color:var(--t2);background:0;border:1px solid var(--brd);cursor:pointer;display:flex;align-items:center;gap:3px;transition:.15s}
.hb:hover{background:var(--bgH);color:var(--t1)}
.hb.ac{background:var(--acc);border-color:var(--acc);color:#fff}

/* ═══ MAIN ═══ */
.mn{flex:1;display:flex;overflow:hidden;min-height:0}

/* Left Sidebar — Koyfin-style icon strip + expandable sub-panel */
.sidebar-wrap{display:flex;flex-shrink:0;height:100%}
.lbar{width:40px;background:var(--bg1);border-right:1px solid var(--brd);display:flex;flex-direction:column;align-items:center;padding:4px 0;gap:0;flex-shrink:0;z-index:10}
.lb{width:28px;height:28px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:13px;cursor:pointer;color:var(--t3);background:0;border:0;position:relative;transition:.12s;margin:1px 0}
.lb:hover{background:var(--bgH);color:var(--t1)}
.lb.on{background:transparent;color:var(--acc)}
.lb.on::before{content:'';position:absolute;left:-6px;top:4px;bottom:4px;width:2px;border-radius:1px;background:var(--acc)}
.lb .tp{position:absolute;left:calc(100% + 8px);top:50%;transform:translateY(-50%);padding:2px 6px;border-radius:3px;background:var(--bg3);border:1px solid var(--brd);color:var(--t1);font-size:9px;white-space:nowrap;opacity:0;pointer-events:none;transition:.12s;z-index:99}
.lb:hover .tp{opacity:1}
.lsep{width:16px;height:1px;background:var(--brd);margin:6px 0}

/* Sub-panel (expandable) — Koyfin density */
.sub-panel{width:0;overflow:hidden;background:var(--bg1);border-right:1px solid transparent;transition:width .2s ease,border-color .2s ease;display:flex;flex-direction:column}
.sub-panel.open{width:192px;border-right-color:var(--brd)}
.sub-panel-header{padding:6px 10px 4px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;border-bottom:1px solid var(--brd)}
.sub-panel-title{font-size:10px;font-weight:700;color:var(--t2);text-transform:uppercase;letter-spacing:.5px}
.sub-panel-close{background:0;border:0;color:var(--t3);cursor:pointer;font-size:11px;padding:2px;border-radius:3px;transition:.12s}
.sub-panel-close:hover{background:var(--bgH);color:var(--t1)}
.sub-panel-list{flex:1;overflow-y:auto;padding:4px 4px 6px}
.sub-item{display:flex;align-items:center;gap:6px;padding:4px 8px;border-radius:3px;cursor:pointer;transition:.1s;font-size:11px;color:var(--t2);position:relative;border-left:2px solid transparent;margin:0 0 0 0}
.sub-item:hover{background:var(--bgH);color:var(--t1);border-left-color:var(--brd2)}
.sub-item.active{color:var(--t1);border-left-color:var(--acc);background:rgba(37,99,235,.06)}
.sub-item-icon{font-size:9px;flex-shrink:0;width:16px;text-align:center;color:var(--t3);font-weight:600;font-family:'SF Mono',monospace}
.sub-item-text{display:flex;flex-direction:column;min-width:0}
.sub-item-name{font-weight:500;font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sub-item-desc{font-size:7px;color:var(--t3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px}
.sub-sep{height:1px;background:var(--brd);margin:3px 8px}

/* ═══ CSS ICONS (sidebar) ═══ */
.ico{width:14px;height:14px;position:relative;display:inline-block}
.ico-chart{border-left:1.5px solid currentColor;border-bottom:1.5px solid currentColor;width:12px;height:10px}
.ico-chart::after{content:'';position:absolute;bottom:1px;left:3px;width:2px;height:4px;background:currentColor;box-shadow:4px 0 0 0 currentColor, 4px -3px 0 0 currentColor, -4px 1px 0 0 currentColor}
.ico-heat{width:12px;height:10px;display:grid;grid-template-columns:1fr 1fr;gap:1px}
.ico-heat::before,.ico-heat::after{content:'';border-radius:1px}
.ico-heat::before{background:var(--grn);box-shadow:inset 0 0 0 4px var(--grn)}
.ico-heat::after{background:var(--red);box-shadow:inset 0 0 0 4px var(--red)}
.ico-fund{width:10px;height:12px;border:1.5px solid currentColor;border-radius:1px;position:relative}
.ico-fund::after{content:'';position:absolute;top:3px;left:2px;width:4px;height:1px;background:currentColor;box-shadow:0 3px 0 0 currentColor}
.ico-overlay{width:12px;height:12px;position:relative}
.ico-overlay::before{content:'';position:absolute;top:0;left:0;width:8px;height:8px;border:1.5px solid currentColor;border-radius:1px}
.ico-overlay::after{content:'';position:absolute;bottom:0;right:0;width:8px;height:8px;border:1.5px solid var(--acc);border-radius:1px}
.ico-chat{width:12px;height:10px;border:1.5px solid currentColor;border-radius:3px 3px 3px 0;position:relative}
.ico-plus{width:12px;height:12px;position:relative}
.ico-plus::before{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:10px;height:1.5px;background:currentColor}
.ico-plus::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:1.5px;height:10px;background:currentColor}

/* Content */
.ct{flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden}

/* ═══ KLINE WIDGET (self-contained) ═══ */
.kw{flex:1;display:flex;flex-direction:column;min-height:200px;border-bottom:1px solid var(--brd)}

/* KLine Widget Internal Header — TV style */
.kwh{min-height:32px;background:var(--bg1);border-bottom:1px solid var(--brd);display:flex;align-items:center;padding:0 6px;gap:0;flex-shrink:0;flex-wrap:wrap}

/* Row 1: Symbol + Price + Periods */
.kwh-row{display:flex;align-items:center;gap:4px;padding:2px 0;flex-wrap:wrap;width:100%}

/* Symbol selector */
.sym{display:flex;align-items:center;gap:4px;padding:2px 6px;border-radius:4px;cursor:pointer;transition:.15s;position:relative;flex-shrink:0;z-index:201}
.sym:hover{background:var(--bgH)}
.sym-icon{font-size:12px}
.sym-t{font-size:12px;font-weight:600}
.sym-m{font-size:9px;color:var(--t3);background:var(--bg3);padding:0px 4px;border-radius:2px}
.sym-v{font-size:7px;color:var(--t3)}

/* Price */
.prc{font-size:12px;font-weight:600;font-family:'SF Mono',monospace;margin-right:2px}
.chg{font-size:10px;font-family:'SF Mono',monospace;font-weight:500}
.up{color:var(--grn)}.dn{color:var(--red)}

/* Separator */
.vs{width:1px;height:16px;background:var(--brd);margin:0 3px;flex-shrink:0}

/* Period buttons */
.pb{padding:1px 5px;border-radius:3px;font-size:10px;font-weight:500;color:var(--t3);cursor:pointer;background:0;border:0;transition:.15s;flex-shrink:0}
.pb:hover{color:var(--t1);background:var(--bgH)}
.pb.on{color:#fff;background:var(--acc)}

/* Indicator buttons */
.ib{padding:1px 5px;border-radius:3px;font-size:9px;font-weight:600;color:var(--t3);cursor:pointer;background:0;border:0;transition:.15s;flex-shrink:0}
.ib:hover{color:var(--t2)}
.ib.on{color:#60a5fa;background:rgba(96,165,250,.1)}

/* Drawing tools (inside widget header) */
.dt{display:flex;align-items:center;gap:1px;margin-left:auto;flex-shrink:0}
.dtb{width:24px;height:24px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer;color:var(--t3);background:0;border:0;transition:.15s}
.dtb:hover{background:var(--bgH);color:var(--t1)}
.dtb.on{color:var(--acc);background:rgba(37,99,235,.1)}

/* Chart body */
.kbody{flex:1;background:var(--bg2);position:relative;overflow:hidden;min-height:0}

/* Fake candles */
.candles{position:absolute;inset:0;display:flex;align-items:flex-end;gap:2px;padding:30px 55px 40px 35px}
.c{display:flex;flex-direction:column;align-items:center;flex:1;max-width:8px;height:100%;position:relative}
.cw{width:1px;position:absolute}
.cb{width:100%;min-height:2px;border-radius:1px;position:absolute;z-index:1}

/* Grid */
.grd{position:absolute;inset:0;pointer-events:none}
.gl{position:absolute;left:35px;right:48px;height:1px;background:rgba(42,42,74,.35)}
.gll{position:absolute;right:0;transform:translateY(-50%);font-size:8px;color:var(--t3);font-family:monospace;width:46px;text-align:right;padding-right:3px}

/* Volume */
.va{position:absolute;bottom:0;left:35px;right:48px;height:40px;display:flex;align-items:flex-end;gap:2px;opacity:.3}
.vb{flex:1;max-width:8px;border-radius:1px 1px 0 0}

/* VP overlay */
.vpo{position:absolute;top:30px;right:50px;bottom:40px;width:65px;display:flex;flex-direction:column;justify-content:space-between;gap:1px;opacity:.5}
.vpb{height:4px;display:flex;border-radius:1px}
.vpbu{background:rgba(38,166,154,.4)}
.vpse{background:rgba(239,83,80,.4)}

/* WRB markers */
.wrb{position:absolute;pointer-events:none;font-size:8px;font-weight:700;padding:1px 4px;border-radius:2px}

/* MA lines */
.ma-line{position:absolute;top:30px;left:35px;right:48px;bottom:40px;pointer-events:none}
.ma-line svg{width:100%;height:100%}

/* ═══ RESIZE HANDLE ═══ */
.rzh{height:4px;background:var(--brd);cursor:row-resize;flex-shrink:0;transition:.15s}
.rzh:hover{background:var(--acc)}

/* ═══ WIDGET GRID ═══ */
.wg{height:240px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:1px;background:var(--brd);flex-shrink:0;overflow:hidden}

/* Widget Panel */
.wp{background:var(--bg2);display:flex;flex-direction:column;overflow:hidden}

/* Widget panel header — also self-contained */
.wph{height:26px;background:var(--bg3);border-bottom:1px solid var(--brd);display:flex;align-items:center;padding:0 6px;gap:4px;flex-shrink:0}
.wph-title{font-size:9px;font-weight:600;color:var(--t2);text-transform:uppercase;letter-spacing:.3px;display:flex;align-items:center;gap:3px}
.wph-sym{font-size:9px;font-weight:500;color:var(--t1);cursor:pointer;padding:1px 4px;border-radius:2px;transition:.15s}
.wph-sym:hover{background:var(--bgH)}
.wph-spc{flex:1}
.wph-btn{width:16px;height:16px;border-radius:3px;border:0;background:0;color:var(--t3);font-size:9px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.wph-btn:hover{background:var(--bgH);color:var(--t1)}

.wpb{flex:1;overflow:hidden;padding:5px;min-height:0}

/* ═══ HEATMAP ═══ */
.hmg{display:grid;grid-template-columns:repeat(4,1fr);grid-template-rows:repeat(3,1fr);gap:2px;height:100%}
.hmc{border-radius:3px;display:flex;flex-direction:column;align-items:center;justify-content:center}
.hmc .s{font-size:8px;opacity:.9}.hmc .p{font-size:10px;font-weight:700}

/* ═══ FUNDAMENTALS ═══ */
.fg{display:grid;grid-template-columns:1fr 1fr;gap:3px;align-content:start}
.fi{display:flex;justify-content:space-between;padding:2px 5px;border-radius:3px;background:var(--bg3)}
.fl{font-size:8px;color:var(--t3)}.fv{font-size:9px;font-weight:600;font-family:monospace}

/* VP widget CSS removed — VP is now KLine overlay only */

/* ═══ CHAT ═══ */
.cp{width:300px;background:var(--bg1);border-left:1px solid var(--brd);display:flex;flex-direction:column;flex-shrink:0}
.ch{height:40px;border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between;padding:0 10px;flex-shrink:0}
.chtl{font-size:12px;font-weight:600;display:flex;align-items:center;gap:5px}
.cdot{width:5px;height:5px;border-radius:50%;background:var(--grn);box-shadow:0 0 3px var(--grn)}
.cm{flex:1;padding:10px;overflow-y:auto;display:flex;flex-direction:column;gap:8px}
.msg{max-width:90%;padding:7px 10px;border-radius:10px;font-size:11px;line-height:1.4}
.msg.a{background:var(--bg3);align-self:flex-start;border-bottom-left-radius:3px}
.msg.u{background:var(--acc);color:#fff;align-self:flex-end;border-bottom-right-radius:3px}
.tb{display:inline-flex;align-items:center;gap:2px;padding:1px 5px;border-radius:3px;background:rgba(96,165,250,.15);color:#60a5fa;font-size:9px;font-weight:500;margin-top:4px}
.cqa{padding:6px 10px;display:flex;gap:4px;flex-wrap:wrap;border-top:1px solid var(--brd)}
.qa{padding:3px 8px;border-radius:10px;font-size:10px;color:var(--t2);background:var(--bg3);border:1px solid var(--brd);cursor:pointer;white-space:nowrap;transition:.15s}
.qa:hover{background:var(--bgH);color:var(--t1);border-color:var(--acc)}
.ci{padding:6px 10px;border-top:1px solid var(--brd);display:flex;gap:6px;flex-shrink:0}
.ci input{flex:1;padding:6px 10px;border-radius:6px;border:1px solid var(--brd);background:var(--bg3);color:var(--t1);font-size:11px;outline:0}
.ci input::placeholder{color:var(--t3)}
.ci input:focus{border-color:var(--acc)}
.csb{width:28px;height:28px;border-radius:6px;background:var(--acc);color:#fff;border:0;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0}

/* Dropdown — overlay mode, covers chart */
.dd-overlay{display:none;position:fixed;inset:0;z-index:199}
.dd-overlay.show{display:block}
.dd{position:absolute;top:100%;left:0;margin-top:3px;width:280px;max-height:360px;overflow-y:auto;background:var(--bg1);border:1px solid var(--brd2);border-radius:8px;padding:4px;box-shadow:0 12px 40px rgba(0,0,0,.6);z-index:200;display:none}
.dd.show{display:block}
.dd input{width:calc(100% - 8px);margin:4px 4px 6px;padding:6px 8px;border-radius:4px;border:1px solid var(--brd);background:var(--bg3);color:var(--t1);font-size:11px;outline:0}
.dd input:focus{border-color:var(--acc)}
.dd-section{font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;padding:6px 6px 2px;font-weight:600}
.ddi{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border-radius:4px;cursor:pointer;transition:.1s}
.ddi:hover{background:var(--bgH)}
.ddi .dn_{font-size:11px;font-weight:600}.ddi .dm{font-size:9px;color:var(--t3);margin-left:4px}
.ddi .dk{font-size:8px;padding:1px 4px;border-radius:2px;background:var(--bg3);color:var(--t3)}

/* ═══ INDICATOR SELECTOR ═══ */
.ind-sel{position:relative;z-index:201;display:inline-flex;align-items:center}
.ind-trigger{padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600;color:var(--t2);cursor:pointer;background:var(--bg3);border:1px solid var(--brd);transition:.15s;display:flex;align-items:center;gap:3px;white-space:nowrap}
.ind-trigger:hover{background:var(--bgH);color:var(--t1);border-color:var(--brd2)}
.ind-count{background:var(--acc);color:#fff;font-size:8px;padding:0 4px;border-radius:8px;font-weight:700;min-width:14px;text-align:center}
.ind-panel{width:240px}
.ind-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:4px;cursor:pointer;transition:.1s}
.ind-item:hover{background:var(--bgH)}
.ind-toggle{width:28px;height:16px;border-radius:8px;background:var(--bg3);border:1px solid var(--brd);position:relative;transition:.2s;flex-shrink:0}
.ind-toggle::after{content:'';position:absolute;top:2px;left:2px;width:10px;height:10px;border-radius:50%;background:var(--t3);transition:.2s}
.ind-item.on .ind-toggle{background:var(--acc);border-color:var(--acc)}
.ind-item.on .ind-toggle::after{left:14px;background:#fff}
.ind-name{font-size:11px;font-weight:600;min-width:36px}
.ind-item .dm{font-size:9px;color:var(--t3)}
.ind-tags{display:flex;gap:2px;flex-wrap:wrap}
.ind-tag{font-size:8px;font-weight:600;padding:1px 4px;border-radius:3px;background:rgba(96,165,250,.1);color:#60a5fa}

/* Widget label annotations */
.wlbl{position:absolute;font-size:9px;color:var(--t2);font-weight:500;opacity:.6;pointer-events:none;z-index:5}

/* ═══ LAYOUT LABELS ═══ */
.t-label{position:absolute;font-size:9px;font-weight:700;color:#60a5fa;background:rgba(37,99,235,.12);padding:2px 8px;border-radius:3px;pointer-events:none;z-index:500;white-space:nowrap;letter-spacing:.5px;border:1px solid rgba(37,99,235,.25)}

/* ═══ RESPONSIVE ═══ */
@media(max-width:768px){
  .cp{display:none} /* 手机隐藏聊天面板 */
  .lbar{width:34px}
  .lb{width:24px;height:24px;font-size:11px}
  .wg{grid-template-columns:1fr;height:auto;max-height:300px;overflow-y:auto}
  .kwh-row{flex-wrap:wrap;gap:2px}
  .sym-t{font-size:11px}
  .sym-m{display:none}
  .prc{font-size:11px}
  .chg{font-size:9px}
  .dt{display:none} /* 手机隐藏画图工具 */
  .ind-tags{display:none} /* 手机隐藏 tag */
  .dd{width:calc(100vw - 60px);left:-6px}
  .ind-panel{width:calc(100vw - 60px)}
}
@media(max-width:480px){
  .lbar{display:none}
  .hdr{padding:0 6px;gap:6px}
  .pill{font-size:9px;padding:2px 5px}
}
</style>
</head>
<body>

<!-- ═══ HEADER BAR — Global only ═══ -->
<div class="hdr" style="position:relative">
  <span class="t-label" style="right:80px;top:50%;transform:translateY(-50%)">T1: HeaderBar</span>
  <div class="logo">GainLab</div>
  <div class="hsep"></div>
  <div class="pills">
    <div class="pill on"><div class="dot dg"></div>Crypto</div>
    <div class="pill"><div class="dot dr"></div>US</div>
    <div class="pill"><div class="dot dr"></div>A股</div>
    <div class="pill"><div class="dot dg"></div>贵金属</div>
  </div>
  <div class="spc"></div>
  <!-- hsep removed with ticker -->
  <div class="hb" style="font-size:10px">◐</div>
  <div class="hb ac">Agent</div>
</div>

<!-- ═══ MAIN ═══ -->
<div class="mn">

  <!-- Left: Sidebar wrap (icon bar + expandable sub-panel) -->
  <div class="sidebar-wrap">
    <div class="lbar" style="position:relative">
      <span class="t-label" style="bottom:4px;left:50%;transform:translateX(-50%);font-size:7px;padding:1px 4px">T2</span>
      <button class="lb" style="font-size:9px;color:var(--t2);font-weight:700;letter-spacing:-.5px" title="GainLab">
        <span style="background:linear-gradient(135deg,#60a5fa,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent">GL</span>
      </button>
      <div class="lsep"></div>
      <button class="lb on" data-panel="charts" onclick="togglePanel('charts',this)"><span class="ico ico-chart"></span><span class="tp">图表</span></button>
      <button class="lb" data-panel="heatmap" onclick="togglePanel('heatmap',this)"><span class="ico ico-heat"></span><span class="tp">热力图</span></button>
      <button class="lb" data-panel="fundamentals" onclick="togglePanel('fundamentals',this)"><span class="ico ico-fund"></span><span class="tp">基本面</span></button>
      <button class="lb" data-panel="overlay" onclick="togglePanel('overlay',this)"><span class="ico ico-overlay"></span><span class="tp">叠加对比</span></button>
      <div class="lsep"></div>
      <button class="lb" data-panel="ai" onclick="togglePanel('ai',this)"><span class="ico ico-chat"></span><span class="tp">AI 对话</span></button>
      <div style="flex:1"></div>
      <button class="lb" data-panel="all" onclick="togglePanel('all',this)" style="color:var(--acc)"><span class="ico ico-plus"></span><span class="tp">添加 Widget</span></button>
    </div>
    <!-- Expandable sub-panel -->
    <div class="sub-panel" id="subPanel">
      <div class="sub-panel-header">
        <span class="sub-panel-title" id="subPanelTitle">图表</span>
        <button class="sub-panel-close" onclick="closePanel()">✕</button>
      </div>
      <div class="sub-panel-list" id="subPanelList"></div>
    </div>
  </div>

  <!-- Content -->
  <div class="ct">

    <!-- ═══ K-LINE WIDGET (fully self-contained, TV-style) ═══ -->
    <div class="kw" style="position:relative">
      <span class="t-label" style="top:34px;left:8px;font-size:7px;padding:1px 4px;opacity:.7">T3</span>
      <!-- Widget-internal header: Symbol + Price + Period + Indicator + Drawing tools -->
      <div class="kwh">
        <div class="kwh-row">
          <!-- Symbol selector (like TV) -->
          <div class="sym" id="symSel" onclick="toggleDD()">
            <span class="sym-icon" style="font-size:10px;color:var(--t3)">⌕</span>
            <span class="sym-t">BTCUSDT</span>
            <span class="sym-m">Crypto</span>
            <span class="sym-v">▾</span>
            <div class="dd-overlay" id="ddOverlay" onclick="closeDD(event)"></div>
            <div class="dd" id="dd">
              <input type="text" placeholder="搜索标的 / Search symbol..." id="ddInput">
              <div class="dd-section">Crypto</div>
              <div class="ddi" data-sym="BTCUSDT" data-mkt="Crypto"><div><span class="dn_">BTC/USDT</span><span class="dm">Bitcoin</span></div><span class="dk">Crypto</span></div>
              <div class="ddi" data-sym="ETHUSDT" data-mkt="Crypto"><div><span class="dn_">ETH/USDT</span><span class="dm">Ethereum</span></div><span class="dk">Crypto</span></div>
              <div class="ddi" data-sym="SOLUSDT" data-mkt="Crypto"><div><span class="dn_">SOL/USDT</span><span class="dm">Solana</span></div><span class="dk">Crypto</span></div>
              <div class="dd-section">US Stocks</div>
              <div class="ddi" data-sym="AAPL" data-mkt="US"><div><span class="dn_">AAPL</span><span class="dm">Apple Inc.</span></div><span class="dk">US</span></div>
              <div class="ddi" data-sym="NVDA" data-mkt="US"><div><span class="dn_">NVDA</span><span class="dm">NVIDIA</span></div><span class="dk">US</span></div>
              <div class="ddi" data-sym="MSFT" data-mkt="US"><div><span class="dn_">MSFT</span><span class="dm">Microsoft</span></div><span class="dk">US</span></div>
              <div class="dd-section">A股</div>
              <div class="ddi" data-sym="601318" data-mkt="A股"><div><span class="dn_">601318</span><span class="dm">中国平安</span></div><span class="dk">A股</span></div>
              <div class="ddi" data-sym="600519" data-mkt="A股"><div><span class="dn_">600519</span><span class="dm">贵州茅台</span></div><span class="dk">A股</span></div>
              <div class="dd-section">Commodities</div>
              <div class="ddi" data-sym="XAUUSD" data-mkt="Metal"><div><span class="dn_">XAU/USD</span><span class="dm">Gold</span></div><span class="dk">Metal</span></div>
              <div class="ddi" data-sym="XAGUSD" data-mkt="Metal"><div><span class="dn_">XAG/USD</span><span class="dm">Silver</span></div><span class="dk">Metal</span></div>
            </div>
          </div>

          <span class="prc up">68,144.10</span>
          <span class="chg up">+2.34%</span>

          <div class="vs"></div>

          <!-- Period (in widget, like TV) -->
          <button class="pb">1m</button>
          <button class="pb">5m</button>
          <button class="pb">15m</button>
          <button class="pb">1H</button>
          <button class="pb">4H</button>
          <button class="pb on">1D</button>
          <button class="pb">1W</button>

          <div class="vs"></div>

          <!-- Chart type (candle style) -->
          <button class="dtb on" title="蜡烛图" style="font-size:10px;font-weight:700">K</button>

          <div class="vs"></div>

          <!-- Indicator selector (overlay panel) -->
          <div class="ind-sel" id="indSel">
            <button class="ib ind-trigger" onclick="toggleInd()">fx 指标 <span class="ind-count">4</span> ▾</button>
            <div class="dd-overlay ind-overlay" id="indOverlay" onclick="closeInd(event)"></div>
            <div class="dd ind-panel" id="indPanel">
              <input type="text" placeholder="搜索指标..." id="indInput">
              <div class="dd-section">主图叠加</div>
              <div class="ind-item on" data-ind="MA"><div class="ind-toggle"></div><span class="ind-name">MA</span><span class="dm">移动平均线</span></div>
              <div class="ind-item" data-ind="EMA"><div class="ind-toggle"></div><span class="ind-name">EMA</span><span class="dm">指数移动平均</span></div>
              <div class="ind-item on" data-ind="BOLL"><div class="ind-toggle"></div><span class="ind-name">BOLL</span><span class="dm">布林带</span></div>
              <div class="ind-item on" data-ind="VWAP"><div class="ind-toggle"></div><span class="ind-name">VWAP</span><span class="dm">成交量加权均价</span></div>
              <div class="ind-item on" data-ind="VP"><div class="ind-toggle"></div><span class="ind-name">VP</span><span class="dm">筹码分布</span></div>
              <div class="ind-item" data-ind="WRB"><div class="ind-toggle"></div><span class="ind-name">WRB</span><span class="dm">宽幅K线信号</span></div>
              <div class="dd-section">副图指标</div>
              <div class="ind-item" data-ind="RSI"><div class="ind-toggle"></div><span class="ind-name">RSI</span><span class="dm">相对强弱</span></div>
              <div class="ind-item" data-ind="MACD"><div class="ind-toggle"></div><span class="ind-name">MACD</span><span class="dm">指数平滑异同</span></div>
              <div class="ind-item" data-ind="KDJ"><div class="ind-toggle"></div><span class="ind-name">KDJ</span><span class="dm">随机指标</span></div>
              <div class="ind-item" data-ind="ATR"><div class="ind-toggle"></div><span class="ind-name">ATR</span><span class="dm">真实波幅</span></div>
            </div>
          </div>
          <!-- Active indicator tags -->
          <span class="ind-tags" id="indTags"></span>

          <div class="vs"></div>

          <!-- Drawing tools (in widget, like TV MarkBar) -->
          <div class="dt">
            <button class="dtb" title="趋势线">╱</button>
            <button class="dtb" title="水平线">━</button>
            <button class="dtb" title="矩形">▭</button>
            <button class="dtb" title="斐波那契" style="font-size:9px;font-weight:700;font-family:'SF Mono',monospace">Fib</button>
            <button class="dtb" title="标注" style="font-size:10px">⊕</button>
            <button class="dtb" title="更多画图">⋯</button>
          </div>

          <!-- Widget controls (right side) -->
          <div style="margin-left:auto;display:flex;gap:1px">
            <button class="dtb" title="设置" style="font-size:13px">⚙</button>
            <button class="dtb" title="截图" style="font-size:11px">⎘</button>
            <button class="dtb" title="全屏">⛶</button>
          </div>
        </div>
      </div>

      <!-- Chart body -->
      <div class="kbody">
        <div class="grd">
          <div class="gl" style="top:12%"><span class="gll">72,000</span></div>
          <div class="gl" style="top:30%"><span class="gll">70,000</span></div>
          <div class="gl" style="top:50%"><span class="gll">68,000</span></div>
          <div class="gl" style="top:70%"><span class="gll">66,000</span></div>
          <div class="gl" style="top:88%"><span class="gll">64,000</span></div>
        </div>
        <div class="candles" id="candles"></div>
        <div class="va" id="vol"></div>
        <div class="vpo" id="vpo"></div>
        
        <!-- WRB markers -->
        <div class="wrb" style="top:20%;left:28%;background:rgba(38,166,154,.2);color:var(--grn);border:1px solid rgba(38,166,154,.4)">▲ Bull</div>
        <div class="wrb" style="top:55%;left:62%;background:rgba(239,83,80,.2);color:var(--red);border:1px solid rgba(239,83,80,.4)">▼ Bear</div>
        <div class="wrb" style="top:35%;left:75%;background:rgba(38,166,154,.2);color:var(--grn);border:1px solid rgba(38,166,154,.4)">▲ Bull</div>

        <!-- POC label -->
        <div style="position:absolute;top:48%;right:50px;font-size:8px;color:var(--gld);font-weight:600;pointer-events:none">── POC 67,850</div>
        
        <!-- Current price line -->
        <div style="position:absolute;top:38%;left:35px;right:0;border-top:1px solid var(--grn);opacity:.5;pointer-events:none"></div>
        <div style="position:absolute;top:38%;right:0;background:var(--grn);color:#fff;font-size:8px;padding:1px 4px;font-family:monospace;font-weight:600;pointer-events:none">68,144</div>
      </div>
    </div>

    <!-- Resize -->
    <div class="rzh"></div>

    <!-- ═══ BOTTOM WIDGET GRID ═══ -->
    <div class="wg">

      <!-- Widget: Heatmap -->
      <div class="wp">
        <div class="wph">
          <div class="wph-title">HEATMAP</div>
          <div class="wph-sym">Crypto ▾</div>
          <div class="wph-spc"></div>
          <button class="wph-btn">⟲</button>
          <button class="wph-btn">⛶</button>
          <button class="wph-btn">✕</button>
        </div>
        <div class="wpb">
          <div class="hmg" id="hm"></div>
        </div>
      </div>

      <!-- Widget: Fundamentals -->
      <div class="wp">
        <div class="wph">
          <div class="wph-title">FUNDAMENTALS</div>
          <div class="wph-sym">AAPL ▾</div>
          <div class="wph-spc"></div>
          <button class="wph-btn">⟲</button>
          <button class="wph-btn">⛶</button>
          <button class="wph-btn">✕</button>
        </div>
        <div class="wpb">
          <div class="fg">
            <div class="fi"><span class="fl">P/E</span><span class="fv">33.2</span></div>
            <div class="fi"><span class="fl">P/B</span><span class="fv">62.8</span></div>
            <div class="fi"><span class="fl">MktCap</span><span class="fv up">3.45T</span></div>
            <div class="fi"><span class="fl">Rev</span><span class="fv">391B</span></div>
            <div class="fi"><span class="fl">EPS</span><span class="fv up">6.73</span></div>
            <div class="fi"><span class="fl">DivYield</span><span class="fv">0.44%</span></div>
            <div class="fi"><span class="fl">ROE</span><span class="fv up">171%</span></div>
            <div class="fi"><span class="fl">D/E</span><span class="fv">1.87</span></div>
            <div class="fi"><span class="fl">52W Hi</span><span class="fv">260</span></div>
            <div class="fi"><span class="fl">52W Lo</span><span class="fv">164</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ CHAT PANEL ═══ -->
  <div class="cp">
    <div class="ch">
      <div class="chtl"><div class="cdot"></div> GainLab AI</div>
      <button style="background:0;border:0;color:var(--t2);cursor:pointer;font-size:14px">✕</button>
    </div>
    <div class="cm">
      <div class="msg a">Hi — 我可以帮你分析行情、生成图表。试试下面的快捷操作：</div>
      <div class="msg u">帮我看看 BTC 的筹码分布</div>
      <div class="msg a">
        BTC/USDT 筹码分析完成<br><br>
        <b>POC:</b> $67,850<br>
        <b>VAH:</b> $69,200 · <b>VAL:</b> $66,400<br><br>
        当前价在 POC 上方，多头占优。
        <div class="tb">volume_profile → K线已叠加</div>
      </div>
      <div class="msg u">对比 AAPL 和 MSFT</div>
      <div class="msg a">
        正在获取基本面数据...
        <div class="tb">fundamentals ···</div>
      </div>
    </div>
    <div class="cqa">
      <div class="qa">BTC 筹码</div>
      <div class="qa">热力图</div>
      <div class="qa">AAPL K线</div>
      <div class="qa">WRB 信号</div>
    </div>
    <div class="ci">
      <input type="text" placeholder="输入指令或问题...">
      <button class="csb">↑</button>
    </div>
  </div>
</div>

<script>
function genCandles(){
  const el=document.getElementById('candles'),vol=document.getElementById('vol');
  let p=67000,h='',v='';
  for(let i=0;i<75;i++){
    p=Math.max(63500,Math.min(72000,p+(Math.random()-.48)*750));
    const o=p-400+Math.random()*800,c=p,hi=Math.max(o,c)+Math.random()*350,lo=Math.min(o,c)-Math.random()*350;
    const bull=c>=o,col=bull?'var(--grn)':'var(--red)';
    const t=((72000-hi)/8500)*100,b=((72000-lo)/8500)*100;
    const bt=((72000-Math.max(o,c))/8500)*100,bb=((72000-Math.min(o,c))/8500)*100;
    h+=`<div class="c"><div class="cw" style="top:${t}%;height:${b-t}%;background:${col}"></div><div class="cb" style="top:${bt}%;height:${Math.max(bb-bt,.5)}%;background:${col}"></div></div>`;
    v+=`<div class="vb" style="height:${Math.random()*32+4}px;background:${col}"></div>`;
  }
  el.innerHTML=h;vol.innerHTML=v;
}
function genVP(){
  const el=document.getElementById('vpo');
  const vs=[25,35,50,65,75,85,100,90,70,55,40,20];
  let h='';
  vs.forEach((v)=>{const b=Math.random()*.6+.2;
    h+=`<div class="vpb"><div class="vpbu" style="width:${v*b}%"></div><div class="vpse" style="width:${v*(1-b)}%"></div></div>`;
  });
  el.innerHTML=h;
}
function genHM(){
  const d=[{s:'BTC',p:2.3},{s:'ETH',p:1.8},{s:'SOL',p:5.2},{s:'BNB',p:-.4},{s:'XRP',p:-1.2},{s:'ADA',p:3.1},{s:'DOGE',p:8.4},{s:'AVAX',p:-2.1},{s:'DOT',p:.8},{s:'LINK',p:4.2},{s:'UNI',p:-.3},{s:'MATIC',p:1.5}];
  document.getElementById('hm').innerHTML=d.map(x=>{
    const g=x.p>=0,i=Math.min(Math.abs(x.p)/8,1),bg=g?`rgba(38,166,154,${.15+i*.4})`:`rgba(239,83,80,${.15+i*.4})`,tc=g?'var(--grn)':'var(--red)';
    return`<div class="hmc" style="background:${bg}"><span class="s" style="color:${tc}">${x.s}</span><span class="p" style="color:${tc}">${x.p>0?'+':''}${x.p}%</span></div>`;
  }).join('');
}
function toggleDD(){
  const dd=document.getElementById('dd'),ov=document.getElementById('ddOverlay');
  const open=!dd.classList.contains('show');
  dd.classList.toggle('show');ov.classList.toggle('show');
  if(open){const inp=document.getElementById('ddInput');inp.value='';inp.focus();filterDD('');}
}
function closeDD(e){
  if(e)e.stopPropagation();
  document.getElementById('dd').classList.remove('show');
  document.getElementById('ddOverlay').classList.remove('show');
}
function filterDD(q){
  q=q.toLowerCase();
  const dd=document.getElementById('dd');
  dd.querySelectorAll('.ddi').forEach(el=>{
    const t=(el.dataset.sym+' '+el.textContent).toLowerCase();
    el.style.display=t.includes(q)?'':'none';
  });
  dd.querySelectorAll('.dd-section').forEach(el=>{
    let next=el.nextElementSibling,vis=false;
    while(next&&!next.classList.contains('dd-section')){
      if(next.classList.contains('ddi')&&next.style.display!=='none')vis=true;
      next=next.nextElementSibling;
    }
    el.style.display=vis?'':'none';
  });
}
document.getElementById('ddInput')?.addEventListener('input',e=>filterDD(e.target.value));
document.querySelectorAll('.ddi').forEach(el=>el.addEventListener('click',function(e){
  e.stopPropagation();
  const sym=this.dataset.sym,mkt=this.dataset.mkt;
  document.querySelector('.sym-t').textContent=sym;
  document.querySelector('.sym-m').textContent=mkt;
  closeDD();genCandles();
}));
// === Indicator panel ===
function toggleInd(){
  const p=document.getElementById('indPanel'),o=document.getElementById('indOverlay');
  const open=!p.classList.contains('show');
  p.classList.toggle('show');o.classList.toggle('show');
  if(open){const inp=document.getElementById('indInput');inp.value='';inp.focus();filterInd('');}
}
function closeInd(e){
  if(e)e.stopPropagation();
  document.getElementById('indPanel').classList.remove('show');
  document.getElementById('indOverlay').classList.remove('show');
}
function filterInd(q){
  q=q.toLowerCase();
  const panel=document.getElementById('indPanel');
  panel.querySelectorAll('.ind-item').forEach(el=>{
    const t=(el.dataset.ind+' '+el.textContent).toLowerCase();
    el.style.display=t.includes(q)?'':'none';
  });
  panel.querySelectorAll('.dd-section').forEach(el=>{
    let next=el.nextElementSibling,vis=false;
    while(next&&!next.classList.contains('dd-section')){
      if(next.classList.contains('ind-item')&&next.style.display!=='none')vis=true;
      next=next.nextElementSibling;
    }
    el.style.display=vis?'':'none';
  });
}
document.getElementById('indInput')?.addEventListener('input',e=>filterInd(e.target.value));
document.querySelectorAll('.ind-item').forEach(el=>el.addEventListener('click',function(e){
  e.stopPropagation();
  this.classList.toggle('on');
  updateIndTags();
}));
function updateIndTags(){
  const active=[];
  document.querySelectorAll('.ind-item.on').forEach(el=>active.push(el.dataset.ind));
  document.querySelector('.ind-count').textContent=active.length;
  document.getElementById('indTags').innerHTML=active.map(n=>`<span class="ind-tag">${n}</span>`).join('');
}
updateIndTags();

// === Period buttons ===
document.querySelectorAll('.pb').forEach(btn=>btn.addEventListener('click',function(){
  document.querySelectorAll('.pb').forEach(b=>b.classList.remove('on'));
  this.classList.add('on');
  genCandles();
}));

genCandles();genVP();genHM();

// ═══ SIDEBAR SUB-PANEL ═══
const panelData={
  charts:{
    title:'图表',
    items:[
      {icon:'K',name:'K线图',desc:'蜡烛图 + 技术指标'},
      {icon:'T',name:'分时图',desc:'实时分时走势'},
      {icon:'D',name:'深度图',desc:'买卖盘口深度'},
      {sep:true},
      {icon:'HA',name:'Heikin-Ashi',desc:'平均K线'},
      {icon:'R',name:'Renko',desc:'砖形图'},
    ]
  },
  heatmap:{
    title:'热力图',
    items:[
      {icon:'C',name:'Crypto 热力图',desc:'加密货币涨跌分布'},
      {icon:'S',name:'板块热力图',desc:'A股/美股板块'},
      {icon:'▲▼',name:'涨跌幅排行',desc:'Top gainers/losers'},
      {sep:true},
      {icon:'G',name:'全球市场',desc:'各国指数概览'},
    ]
  },
  fundamentals:{
    title:'基本面',
    items:[
      {icon:'$',name:'财务概览',desc:'P/E, P/B, ROE 等'},
      {icon:'vs',name:'财报对比',desc:'多标的横向对比'},
      {icon:'CF',name:'现金流',desc:'经营/投资/筹资'},
      {sep:true},
      {icon:'N',name:'新闻摘要',desc:'相关新闻聚合'},
    ]
  },
  overlay:{
    title:'叠加对比',
    items:[
      {icon:'⫽',name:'多资产叠加',desc:'价格走势对比'},
      {icon:'ρ',name:'相关性矩阵',desc:'资产相关性热力图'},
      {icon:'÷',name:'比率图',desc:'A/B 价格比率'},
    ]
  },
  ai:{
    title:'AI 助手',
    items:[
      {icon:'▷',name:'对话面板',desc:'自然语言交互'},
      {icon:'fx',name:'智能分析',desc:'AI 技术分析'},
      {icon:'∑',name:'研报生成',desc:'自动生成分析报告'},
    ]
  },
  all:{
    title:'所有组件',
    items:[
      {icon:'K',name:'K线图',desc:'蜡烛图 + 技术指标'},
      {icon:'T',name:'分时图',desc:'实时分时走势'},
      {icon:'D',name:'深度图',desc:'买卖盘口深度'},
      {sep:true},
      {icon:'C',name:'Crypto 热力图',desc:'加密货币涨跌分布'},
      {icon:'S',name:'板块热力图',desc:'A股/美股板块'},
      {icon:'▲▼',name:'涨跌幅排行',desc:'Top gainers/losers'},
      {sep:true},
      {icon:'$',name:'财务概览',desc:'P/E, P/B, ROE 等'},
      {icon:'vs',name:'财报对比',desc:'多标的横向对比'},
      {sep:true},
      {icon:'⫽',name:'多资产叠加',desc:'价格走势对比'},
      {icon:'▷',name:'对话面板',desc:'自然语言交互'},
    ]
  }
};
let activePanel=null;
function togglePanel(id,btn){
  const panel=document.getElementById('subPanel');
  // If same panel clicked, close it
  if(activePanel===id){closePanel();return;}
  // Update active button
  document.querySelectorAll('.lb[data-panel]').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  // Populate and open
  const data=panelData[id];
  if(!data)return;
  document.getElementById('subPanelTitle').textContent=data.title;
  const list=document.getElementById('subPanelList');
  list.innerHTML=data.items.map(item=>{
    if(item.sep)return'<div class="sub-sep"></div>';
    return`<div class="sub-item"><span class="sub-item-icon">${item.icon}</span><div class="sub-item-text"><span class="sub-item-name">${item.name}</span><span class="sub-item-desc">${item.desc}</span></div></div>`;
  }).join('');
  panel.classList.add('open');
  activePanel=id;
}
function closePanel(){
  document.getElementById('subPanel').classList.remove('open');
  document.querySelectorAll('.lb[data-panel]').forEach(b=>b.classList.remove('on'));
  // Restore default K-line as active
  document.querySelector('.lb[data-panel="charts"]')?.classList.add('on');
  activePanel=null;
}
</script>
</body>
</html>
