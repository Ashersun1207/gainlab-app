<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GainLab Layout Preview — T1/T2/T3 Components</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg0:#08081a;--bg1:#0d0d20;--bg2:#12122a;--bg3:#1a1a3e;
  --bgH:#1e1e3a;--brd:#2a2a4a;--brd2:#3a3a6a;
  --t1:#e0e0f0;--t2:#8888aa;--t3:#5a5a8a;
  --acc:#2563eb;--acc2:#1d4ed8;
  --grn:#26a69a;--red:#ef5350;--gld:#f0b90b;
}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro','Inter',system-ui,sans-serif;background:var(--bg0);color:var(--t1);height:100vh;overflow:hidden;display:flex;flex-direction:column}

/* ═══ HEADER ═══ */
.hdr{height:40px;background:var(--bg1);border-bottom:1px solid var(--brd);display:flex;align-items:center;padding:0 10px;gap:10px;flex-shrink:0;z-index:100}
.logo{font-size:14px;font-weight:700;background:linear-gradient(135deg,#60a5fa,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hsep{width:1px;height:18px;background:var(--brd)}
.pills{display:flex;gap:4px}
.pill{display:flex;align-items:center;gap:3px;padding:2px 7px;border-radius:4px;font-size:10px;font-weight:500;background:var(--bg3);color:var(--t2);cursor:pointer;border:1px solid transparent;transition:.15s}
.pill:hover{background:var(--bgH);color:var(--t1)}
.pill.on{border-color:var(--acc);color:var(--t1);background:rgba(37,99,235,.1)}
.dot{width:4px;height:4px;border-radius:50%;flex-shrink:0}
.dg{background:var(--grn);box-shadow:0 0 3px var(--grn)}.dr{background:var(--t3)}
.spc{flex:1}
/* (ticker removed) */
.hb{padding:3px 8px;border-radius:5px;font-size:11px;font-weight:500;color:var(--t2);background:0;border:1px solid var(--brd);cursor:pointer;display:flex;align-items:center;gap:3px;transition:.15s}
.hb:hover{background:var(--bgH);color:var(--t1)}
.hb.ac{background:var(--acc);border-color:var(--acc);color:#fff}

/* ═══ MAIN ═══ */
.mn{flex:1;display:flex;overflow:hidden;min-height:0}

/* ═══ SIDEBAR — Koyfin single-panel, collapsed/expanded ═══ */
.sidebar{width:42px;background:var(--bg1);border-right:1px solid var(--brd);display:flex;flex-direction:column;flex-shrink:0;z-index:10;transition:width .2s ease;overflow:hidden}
.sidebar.open{width:250px}

/* Top: hamburger + logo row */
.sb-top{height:40px;display:flex;align-items:center;padding:0 3px;flex-shrink:0;border-bottom:1px solid var(--brd);gap:8px;overflow:hidden;justify-content:center}
.sidebar.open .sb-top{justify-content:space-between;padding:0 3px 0 12px}
.sb-toggle{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border:0;background:0;color:var(--t2);cursor:pointer;border-radius:6px;transition:.12s;flex-shrink:0}
.sb-toggle:hover{background:var(--bgH);color:var(--t1)}
.sb-toggle svg{width:18px;height:18px}
.sb-icon-collapse{display:none}
.sidebar.open .sb-icon-expand{display:none}
.sidebar.open .sb-icon-collapse{display:block}
.sb-logo{font-size:14px;font-weight:700;background:linear-gradient(135deg,#60a5fa,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;white-space:nowrap;opacity:0;width:0;overflow:hidden;transition:opacity .15s,width .2s}
.sidebar.open .sb-logo{opacity:1;width:auto}

/* Nav items */
.sb-nav{flex:1;overflow-y:auto;overflow-x:hidden;padding:4px 0}
.sb-section{font-size:9px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.6px;padding:12px 0 4px 14px;user-select:none;white-space:nowrap;overflow:hidden;height:0;opacity:0;transition:height .15s,opacity .15s,padding .15s}
.sidebar.open .sb-section{height:auto;opacity:1;padding:12px 0 4px 14px}
.sb-section:first-child{padding-top:6px}
.sidebar.open .sb-section:first-child{padding-top:6px}

.sb-item{display:flex;align-items:center;height:36px;padding:0 3px;cursor:pointer;transition:.1s;color:var(--t2);position:relative;overflow:hidden;white-space:nowrap;gap:0}
.sb-item:hover{background:var(--bgH);color:var(--t1)}
.sb-item.on{color:var(--t1)}

/* Icon wrapper — always centered in 42px collapsed, left-aligned in expanded */
.sb-ico{width:36px;height:36px;display:flex;align-items:center;justify-content:center;flex-shrink:0;border-radius:6px;transition:.12s}
.sb-ico svg{width:16px;height:16px}
.sb-item.on .sb-ico{background:var(--acc);color:#fff}

/* Text + badge — hidden when collapsed, visible when open */
.sb-text{font-size:12px;font-weight:500;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;opacity:0;transition:opacity .15s;margin-left:6px}
.sidebar.open .sb-text{opacity:1}
.sb-badge{font-size:8px;font-weight:700;color:var(--t3);background:var(--bg3);padding:1px 5px;border-radius:3px;border:1px solid var(--brd);letter-spacing:.3px;flex-shrink:0;opacity:0;transition:opacity .15s;margin-right:8px}
.sidebar.open .sb-badge{opacity:1}

/* Separator */
.sb-sep{height:1px;margin:4px 10px;background:var(--brd)}

/* Tooltip (collapsed only) */
.sb-item .sb-tip{position:absolute;left:46px;top:50%;transform:translateY(-50%);padding:3px 8px;border-radius:4px;background:#1a1a2e;border:1px solid var(--brd2);color:var(--t1);font-size:10px;white-space:nowrap;opacity:0;pointer-events:none;transition:.12s;z-index:99;box-shadow:0 4px 12px rgba(0,0,0,.4)}
.sb-item:hover .sb-tip{opacity:1}
.sidebar.open .sb-item .sb-tip{opacity:0 !important;pointer-events:none}

/* Bottom spacer + add button */
.sb-bottom{flex-shrink:0;padding:4px 3px 8px;border-top:1px solid var(--brd)}

/* Content */
.ct{flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden}

/* ═══ KLINE WIDGET (self-contained) ═══ */
.kw{flex:1;display:flex;flex-direction:column;min-height:200px;border-bottom:1px solid var(--brd)}

/* KLine Widget Internal Header — TV style */
.kwh{min-height:32px;background:var(--bg1);border-bottom:1px solid var(--brd);display:flex;align-items:center;padding:0 6px;gap:0;flex-shrink:0;flex-wrap:wrap}

/* Row 1: Symbol + Price + Periods */
.kwh-row{display:flex;align-items:center;gap:4px;padding:2px 0;flex-wrap:wrap;width:100%}

/* Symbol selector */
.sym{display:flex;align-items:center;gap:4px;padding:2px 6px;border-radius:4px;cursor:pointer;transition:.15s;position:relative;flex-shrink:0;z-index:201}
.sym:hover{background:var(--bgH)}
.sym-icon{font-size:12px}
.sym-t{font-size:12px;font-weight:600}
.sym-m{font-size:9px;color:var(--t3);background:var(--bg3);padding:0px 4px;border-radius:2px}
.sym-v{font-size:7px;color:var(--t3)}

/* Price */
.prc{font-size:12px;font-weight:600;font-family:'SF Mono',monospace;margin-right:2px}
.chg{font-size:10px;font-family:'SF Mono',monospace;font-weight:500}
.up{color:var(--grn)}.dn{color:var(--red)}

/* Separator */
.vs{width:1px;height:16px;background:var(--brd);margin:0 3px;flex-shrink:0}

/* Period: common shortcuts + dropdown */
.pd-wrap{display:flex;align-items:center;gap:2px}
.pb{padding:1px 5px;border-radius:3px;font-size:10px;font-weight:500;color:var(--t3);cursor:pointer;background:0;border:0;transition:.15s;flex-shrink:0}
.pb:hover{color:var(--t1);background:var(--bgH)}
.pb.on{color:#fff;background:var(--acc)}
.pd-dd-wrap{position:relative}
.pd-dd-btn{padding:1px 5px;border-radius:3px;font-size:10px;font-weight:500;color:var(--t2);cursor:pointer;background:0;border:0;transition:.15s;display:flex;align-items:center;gap:2px}
.pd-dd-btn:hover{color:var(--t1);background:var(--bgH)}
.pd-dd{display:none;position:absolute;top:calc(100% + 4px);right:0;background:var(--bg2);border:1px solid var(--brd2);border-radius:6px;padding:6px 4px;min-width:140px;box-shadow:0 8px 24px rgba(0,0,0,.5);z-index:300;max-height:280px;overflow-y:auto}
.pd-dd.show{display:block}
.pd-item{display:flex;align-items:center;justify-content:space-between;padding:3px 6px;border-radius:4px;font-size:10px;cursor:pointer;transition:.12s;gap:6px}
.pd-item:hover{background:var(--bgH)}
.pd-item .pd-name{flex:1;color:var(--t2);font-weight:500}
.pd-item.active .pd-name{color:var(--acc);font-weight:600}
.pd-star{width:14px;height:14px;border:0;background:0;cursor:pointer;color:var(--t3);padding:0;display:flex;align-items:center;justify-content:center;transition:.12s;flex-shrink:0}
.pd-star:hover{color:var(--acc)}
.pd-star.on{color:var(--acc)}
.pd-dd-bg{position:fixed;inset:0;z-index:299;display:none}
.pd-dd-bg.show{display:block}

/* Indicator buttons */
.ib{padding:1px 5px;border-radius:3px;font-size:9px;font-weight:600;color:var(--t3);cursor:pointer;background:0;border:0;transition:.15s;flex-shrink:0}
.ib:hover{color:var(--t2)}
.ib.on{color:#60a5fa;background:rgba(96,165,250,.1)}

/* Drawing tools — overlay on chart left edge */
.dt-trigger{width:24px;height:24px;border-radius:4px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--t3);background:0;border:0;transition:.15s;flex-shrink:0}
.dt-trigger:hover{background:var(--bgH);color:var(--t1)}
.dt-trigger.on{color:var(--acc);background:rgba(37,99,235,.1)}
.dt-overlay{position:absolute;top:4px;left:4px;z-index:50;display:flex;flex-direction:column;gap:2px;padding:4px;background:var(--bg1);border:1px solid var(--brd2);border-radius:6px;box-shadow:0 4px 16px rgba(0,0,0,.5);opacity:0;pointer-events:none;transform:translateX(-4px);transition:opacity .15s,transform .15s}
.dt-overlay.show{opacity:1;pointer-events:auto;transform:translateX(0)}
.dtb{width:28px;height:28px;border-radius:4px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--t3);background:0;border:0;transition:.12s}
.dtb:hover{background:var(--bgH);color:var(--t1)}
.dtb.on{color:var(--acc);background:rgba(37,99,235,.1)}
.dtb svg{width:15px;height:15px}

/* Chart body */
.kbody{flex:1;background:var(--bg2);position:relative;overflow:hidden;min-height:0}

/* Fake candles */
.candles{position:absolute;inset:0;display:flex;align-items:flex-end;gap:2px;padding:30px 55px 40px 35px}
.c{display:flex;flex-direction:column;align-items:center;flex:1;max-width:8px;height:100%;position:relative}
.cw{width:1px;position:absolute}
.cb{width:100%;min-height:2px;border-radius:1px;position:absolute;z-index:1}

/* Grid */
.grd{position:absolute;inset:0;pointer-events:none}
.gl{position:absolute;left:35px;right:48px;height:1px;background:rgba(42,42,74,.35)}
.gll{position:absolute;right:0;transform:translateY(-50%);font-size:8px;color:var(--t3);font-family:monospace;width:46px;text-align:right;padding-right:3px}

/* Volume */
.va{position:absolute;bottom:0;left:35px;right:48px;height:40px;display:flex;align-items:flex-end;gap:2px;opacity:.3}
.vb{flex:1;max-width:8px;border-radius:1px 1px 0 0}

/* VP overlay */
.vpo{position:absolute;top:30px;right:50px;bottom:40px;width:65px;display:flex;flex-direction:column;justify-content:space-between;gap:1px;opacity:.5}
.vpb{height:4px;display:flex;border-radius:1px}
.vpbu{background:rgba(38,166,154,.4)}
.vpse{background:rgba(239,83,80,.4)}

/* WRB markers */
.wrb{position:absolute;pointer-events:none;font-size:8px;font-weight:700;padding:1px 4px;border-radius:2px}

/* MA lines */
.ma-line{position:absolute;top:30px;left:35px;right:48px;bottom:40px;pointer-events:none}
.ma-line svg{width:100%;height:100%}

/* ═══ RESIZE HANDLE ═══ */
.rzh{height:4px;background:var(--brd);cursor:row-resize;flex-shrink:0;transition:.15s}
.rzh:hover{background:var(--acc)}

/* ═══ WIDGET GRID ═══ */
.wg{height:240px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:1px;background:var(--brd);flex-shrink:0;overflow:hidden}

/* Widget Panel */
.wp{background:var(--bg2);display:flex;flex-direction:column;overflow:hidden}

/* Widget panel header — also self-contained */
.wph{height:26px;background:var(--bg3);border-bottom:1px solid var(--brd);display:flex;align-items:center;padding:0 6px;gap:4px;flex-shrink:0}
.wph-title{font-size:9px;font-weight:600;color:var(--t2);text-transform:uppercase;letter-spacing:.3px;display:flex;align-items:center;gap:3px}
.wph-sym{font-size:9px;font-weight:500;color:var(--t1);cursor:pointer;padding:1px 4px;border-radius:2px;transition:.15s}
.wph-sym:hover{background:var(--bgH)}
.wph-spc{flex:1}
.wph-btn{width:16px;height:16px;border-radius:3px;border:0;background:0;color:var(--t3);font-size:9px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.wph-btn:hover{background:var(--bgH);color:var(--t1)}

.wpb{flex:1;overflow:hidden;padding:5px;min-height:0}

/* ═══ HEATMAP ═══ */
.hmg{display:grid;grid-template-columns:repeat(4,1fr);grid-template-rows:repeat(3,1fr);gap:2px;height:100%}
.hmc{border-radius:3px;display:flex;flex-direction:column;align-items:center;justify-content:center}
.hmc .s{font-size:8px;opacity:.9}.hmc .p{font-size:10px;font-weight:700}

/* ═══ FUNDAMENTALS ═══ */
.fg{display:grid;grid-template-columns:1fr 1fr;gap:3px;align-content:start}
.fi{display:flex;justify-content:space-between;padding:2px 5px;border-radius:3px;background:var(--bg3)}
.fl{font-size:8px;color:var(--t3)}.fv{font-size:9px;font-weight:600;font-family:monospace}

/* VP widget CSS removed — VP is now KLine overlay only */

/* ═══ CHAT ═══ */
.cp{width:300px;background:var(--bg1);border-left:1px solid var(--brd);display:flex;flex-direction:column;flex-shrink:0}
.ch{height:40px;border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between;padding:0 10px;flex-shrink:0}
.chtl{font-size:12px;font-weight:600;display:flex;align-items:center;gap:5px}
.cdot{width:5px;height:5px;border-radius:50%;background:var(--grn);box-shadow:0 0 3px var(--grn)}
.cm{flex:1;padding:10px;overflow-y:auto;display:flex;flex-direction:column;gap:8px}
.msg{max-width:90%;padding:7px 10px;border-radius:10px;font-size:11px;line-height:1.4}
.msg.a{background:var(--bg3);align-self:flex-start;border-bottom-left-radius:3px}
.msg.u{background:var(--acc);color:#fff;align-self:flex-end;border-bottom-right-radius:3px}
.tb{display:inline-flex;align-items:center;gap:2px;padding:1px 5px;border-radius:3px;background:rgba(96,165,250,.15);color:#60a5fa;font-size:9px;font-weight:500;margin-top:4px}
.cqa{padding:6px 10px;display:flex;gap:4px;flex-wrap:wrap;border-top:1px solid var(--brd)}
.qa{padding:3px 8px;border-radius:10px;font-size:10px;color:var(--t2);background:var(--bg3);border:1px solid var(--brd);cursor:pointer;white-space:nowrap;transition:.15s}
.qa:hover{background:var(--bgH);color:var(--t1);border-color:var(--acc)}
.ci{padding:6px 10px;border-top:1px solid var(--brd);display:flex;gap:6px;flex-shrink:0}
.ci input{flex:1;padding:6px 10px;border-radius:6px;border:1px solid var(--brd);background:var(--bg3);color:var(--t1);font-size:11px;outline:0}
.ci input::placeholder{color:var(--t3)}
.ci input:focus{border-color:var(--acc)}
.csb{width:28px;height:28px;border-radius:6px;background:var(--acc);color:#fff;border:0;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0}

/* Dropdown — overlay mode, covers chart */
.dd-overlay{display:none;position:fixed;inset:0;z-index:199}
.dd-overlay.show{display:block}
.dd{position:absolute;top:100%;left:0;margin-top:3px;width:280px;max-height:360px;overflow-y:auto;background:var(--bg1);border:1px solid var(--brd2);border-radius:8px;padding:4px;box-shadow:0 12px 40px rgba(0,0,0,.6);z-index:200;display:none}
.dd.show{display:block}
.dd input{width:calc(100% - 8px);margin:4px 4px 6px;padding:6px 8px;border-radius:4px;border:1px solid var(--brd);background:var(--bg3);color:var(--t1);font-size:11px;outline:0}
.dd input:focus{border-color:var(--acc)}
.dd-section{font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;padding:6px 6px 2px;font-weight:600}
.ddi{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border-radius:4px;cursor:pointer;transition:.1s}
.ddi:hover{background:var(--bgH)}
.ddi .dn_{font-size:11px;font-weight:600}.ddi .dm{font-size:9px;color:var(--t3);margin-left:4px}
.ddi .dk{font-size:8px;padding:1px 4px;border-radius:2px;background:var(--bg3);color:var(--t3)}

/* ═══ INDICATOR SELECTOR ═══ */
.ind-sel{position:relative;z-index:201;display:inline-flex;align-items:center}
.ind-trigger{padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600;color:var(--t2);cursor:pointer;background:var(--bg3);border:1px solid var(--brd);transition:.15s;display:flex;align-items:center;gap:3px;white-space:nowrap}
.ind-trigger:hover{background:var(--bgH);color:var(--t1);border-color:var(--brd2)}
.ind-count{background:var(--acc);color:#fff;font-size:8px;padding:0 4px;border-radius:8px;font-weight:700;min-width:14px;text-align:center}
.ind-panel{width:240px}
.ind-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:4px;cursor:pointer;transition:.1s}
.ind-item:hover{background:var(--bgH)}
.ind-toggle{width:28px;height:16px;border-radius:8px;background:var(--bg3);border:1px solid var(--brd);position:relative;transition:.2s;flex-shrink:0}
.ind-toggle::after{content:'';position:absolute;top:2px;left:2px;width:10px;height:10px;border-radius:50%;background:var(--t3);transition:.2s}
.ind-item.on .ind-toggle{background:var(--acc);border-color:var(--acc)}
.ind-item.on .ind-toggle::after{left:14px;background:#fff}
.ind-name{font-size:11px;font-weight:600;min-width:36px}
.ind-item .dm{font-size:9px;color:var(--t3)}
.ind-tags{display:flex;gap:2px;flex-wrap:wrap}
.ind-tag{font-size:8px;font-weight:600;padding:1px 4px;border-radius:3px;background:rgba(96,165,250,.1);color:#60a5fa}

/* Widget label annotations */
.wlbl{position:absolute;font-size:9px;color:var(--t2);font-weight:500;opacity:.6;pointer-events:none;z-index:5}

/* ═══ LAYOUT LABELS ═══ */
.t-label{position:absolute;font-size:9px;font-weight:700;color:#60a5fa;background:rgba(37,99,235,.12);padding:2px 8px;border-radius:3px;pointer-events:none;z-index:500;white-space:nowrap;letter-spacing:.5px;border:1px solid rgba(37,99,235,.25)}

/* ═══ RESPONSIVE ═══ */
@media(max-width:768px){
  .cp{display:none} /* 手机隐藏聊天面板 */
  .sidebar{width:36px}
  .sidebar.open{width:220px}
  .sb-ico svg{width:14px;height:14px}
  .wg{grid-template-columns:1fr;height:auto;max-height:300px;overflow-y:auto}
  .kwh-row{flex-wrap:wrap;gap:2px}
  .sym-t{font-size:11px}
  .sym-m{display:none}
  .prc{font-size:11px}
  .chg{font-size:9px}
  .dt-trigger{display:none} /* 手机隐藏画图工具 */
  .dt-overlay{display:none}
  .ind-tags{display:none} /* 手机隐藏 tag */
  .dd{width:calc(100vw - 60px);left:-6px}
  .ind-panel{width:calc(100vw - 60px)}
}
@media(max-width:480px){
  .sidebar{display:none}
  .hdr{padding:0 6px;gap:6px}
  .pill{font-size:9px;padding:2px 5px}
}
</style>
</head>
<body>

<!-- ═══ HEADER BAR — Global only ═══ -->
<div class="hdr" style="position:relative">
  <span class="t-label" style="right:80px;top:50%;transform:translateY(-50%)">T1: HeaderBar</span>
  <div class="logo">GainLab</div>
  <div class="hsep"></div>
  <div class="pills">
    <div class="pill on"><div class="dot dg"></div>Crypto</div>
    <div class="pill"><div class="dot dr"></div>US</div>
    <div class="pill"><div class="dot dr"></div><span data-i18n="pill_ashare">A股</span></div>
    <div class="pill"><div class="dot dg"></div><span data-i18n="pill_metal">贵金属</span></div>
  </div>
  <div class="spc"></div>
  <!-- hsep removed with ticker -->
  <div class="hb" style="font-size:10px">◐</div>
  <div class="hb" id="langBtn" onclick="toggleLang()" style="font-size:10px;font-weight:600;letter-spacing:.3px;min-width:26px;justify-content:center">EN</div>
  <div class="hb ac">Agent</div>
</div>

<!-- ═══ MAIN ═══ -->
<div class="mn">

  <!-- Left: Single sidebar, collapsed/expanded (Koyfin style) -->
  <div class="sidebar" id="sidebar" style="position:relative">
    <span class="t-label" style="bottom:4px;left:50%;transform:translateX(-50%);font-size:7px;padding:1px 4px;z-index:20">T2</span>
    <!-- Top bar: hamburger + logo -->
    <div class="sb-top">
      <span class="sb-logo">GainLab</span>
      <button class="sb-toggle" onclick="toggleSidebar()" id="sbToggle">
        <svg class="sb-icon-expand" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="12,2 15,4.5 12,7"/><line x1="3" y1="4.5" x2="15" y2="4.5"/><line x1="3" y1="9" x2="15" y2="9"/><line x1="3" y1="13.5" x2="15" y2="13.5"/></svg>
        <svg class="sb-icon-collapse" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="6,2 3,4.5 6,7"/><line x1="3" y1="4.5" x2="15" y2="4.5"/><line x1="3" y1="9" x2="15" y2="9"/><line x1="3" y1="13.5" x2="15" y2="13.5"/></svg>
      </button>
    </div>
    <!-- Nav list -->
    <div class="sb-nav" id="sbNav"></div>
    <!-- Bottom: add widget -->
    <div class="sb-bottom">
      <div class="sb-item" onclick="alert('Add widget')">
        <div class="sb-ico"><svg viewBox="0 0 16 16" fill="currentColor"><path d="M7 2h2v5h5v2H9v5H7V9H2V7h5V2z"/></svg></div>
        <span class="sb-text" data-i18n="sb_add">添加 Widget</span>
        <span class="sb-tip" data-i18n="sb_add">添加 Widget</span>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="ct">

    <!-- ═══ K-LINE WIDGET (fully self-contained, TV-style) ═══ -->
    <div class="kw" style="position:relative">
      <span class="t-label" style="top:34px;left:8px;font-size:7px;padding:1px 4px;opacity:.7">T3</span>
      <!-- Widget-internal header: Symbol + Price + Period + Indicator + Drawing tools -->
      <div class="kwh">
        <div class="kwh-row">
          <!-- Symbol selector (like TV) -->
          <div class="sym" id="symSel" onclick="toggleDD()">
            <span class="sym-icon" style="font-size:10px;color:var(--t3)">⌕</span>
            <span class="sym-t">BTCUSDT</span>
            <span class="sym-m">Crypto</span>
            <span class="sym-v">▾</span>
            <div class="dd-overlay" id="ddOverlay" onclick="closeDD(event)"></div>
            <div class="dd" id="dd">
              <input type="text" data-i18n-ph="ph_sym_search" placeholder="搜索标的 / Search symbol..." id="ddInput">
              <div class="dd-section">Crypto</div>
              <div class="ddi" data-sym="BTCUSDT" data-mkt="Crypto"><div><span class="dn_">BTC/USDT</span><span class="dm">Bitcoin</span></div><span class="dk">Crypto</span></div>
              <div class="ddi" data-sym="ETHUSDT" data-mkt="Crypto"><div><span class="dn_">ETH/USDT</span><span class="dm">Ethereum</span></div><span class="dk">Crypto</span></div>
              <div class="ddi" data-sym="SOLUSDT" data-mkt="Crypto"><div><span class="dn_">SOL/USDT</span><span class="dm">Solana</span></div><span class="dk">Crypto</span></div>
              <div class="dd-section">US Stocks</div>
              <div class="ddi" data-sym="AAPL" data-mkt="US"><div><span class="dn_">AAPL</span><span class="dm">Apple Inc.</span></div><span class="dk">US</span></div>
              <div class="ddi" data-sym="NVDA" data-mkt="US"><div><span class="dn_">NVDA</span><span class="dm">NVIDIA</span></div><span class="dk">US</span></div>
              <div class="ddi" data-sym="MSFT" data-mkt="US"><div><span class="dn_">MSFT</span><span class="dm">Microsoft</span></div><span class="dk">US</span></div>
              <div class="dd-section">A股</div>
              <div class="ddi" data-sym="601318" data-mkt="A股"><div><span class="dn_">601318</span><span class="dm">中国平安</span></div><span class="dk">A股</span></div>
              <div class="ddi" data-sym="600519" data-mkt="A股"><div><span class="dn_">600519</span><span class="dm">贵州茅台</span></div><span class="dk">A股</span></div>
              <div class="dd-section">Commodities</div>
              <div class="ddi" data-sym="XAUUSD" data-mkt="Metal"><div><span class="dn_">XAU/USD</span><span class="dm">Gold</span></div><span class="dk">Metal</span></div>
              <div class="ddi" data-sym="XAGUSD" data-mkt="Metal"><div><span class="dn_">XAG/USD</span><span class="dm">Silver</span></div><span class="dk">Metal</span></div>
            </div>
          </div>

          <span class="prc up">68,144.10</span>
          <span class="chg up">+2.34%</span>

          <div class="vs"></div>

          <!-- Period: common shortcuts + dropdown (like dash.gainlab) -->
          <div class="pd-wrap" id="pdWrap">
            <div id="pdCommons"></div>
            <div class="pd-dd-wrap">
              <button class="pd-dd-btn" onclick="togglePdDd()" id="pdDdBtn"></button>
              <div class="pd-dd-bg" id="pdDdBg" onclick="closePdDd()"></div>
              <div class="pd-dd" id="pdDd"></div>
            </div>
          </div>

          <div class="vs"></div>

          <!-- Chart type: icon button + dropdown (like dash.gainlab) -->
          <div class="ct-wrap" style="position:relative">
            <button class="ct-btn" onclick="toggleCtDd()" id="ctBtn" style="padding:2px 4px;border-radius:4px;border:0;background:0;cursor:pointer;color:var(--t2);transition:.15s;display:flex;align-items:center">
              <svg id="ctIcon" viewBox="0 0 16 16" width="16" height="16" fill="currentColor"></svg>
            </button>
            <div class="pd-dd-bg" id="ctDdBg" onclick="closeCtDd()"></div>
            <div class="pd-dd" id="ctDd" style="min-width:130px"></div>
          </div>

          <div class="vs"></div>

          <!-- Indicator selector (overlay panel) -->
          <div class="ind-sel" id="indSel">
            <button class="ib ind-trigger" onclick="toggleInd()">fx <span data-i18n="ind_label">指标</span> <span class="ind-count">4</span> ▾</button>
            <div class="dd-overlay ind-overlay" id="indOverlay" onclick="closeInd(event)"></div>
            <div class="dd ind-panel" id="indPanel">
              <input type="text" data-i18n-ph="ph_ind_search" placeholder="搜索指标..." id="indInput">
              <div class="dd-section" data-i18n="ind_main_overlay">主图叠加</div>
              <div class="ind-item on" data-ind="MA"><div class="ind-toggle"></div><span class="ind-name">MA</span><span class="dm" data-i18n="ind_ma">移动平均线</span></div>
              <div class="ind-item" data-ind="EMA"><div class="ind-toggle"></div><span class="ind-name">EMA</span><span class="dm" data-i18n="ind_ema">指数移动平均</span></div>
              <div class="ind-item on" data-ind="BOLL"><div class="ind-toggle"></div><span class="ind-name">BOLL</span><span class="dm" data-i18n="ind_boll">布林带</span></div>
              <div class="ind-item on" data-ind="VWAP"><div class="ind-toggle"></div><span class="ind-name">VWAP</span><span class="dm" data-i18n="ind_vwap">成交量加权均价</span></div>
              <div class="ind-item on" data-ind="VP"><div class="ind-toggle"></div><span class="ind-name">VP</span><span class="dm" data-i18n="ind_vp">筹码分布</span></div>
              <div class="ind-item" data-ind="WRB"><div class="ind-toggle"></div><span class="ind-name">WRB</span><span class="dm" data-i18n="ind_wrb">宽幅K线信号</span></div>
              <div class="dd-section" data-i18n="ind_sub_panel">副图指标</div>
              <div class="ind-item" data-ind="RSI"><div class="ind-toggle"></div><span class="ind-name">RSI</span><span class="dm" data-i18n="ind_rsi">相对强弱</span></div>
              <div class="ind-item" data-ind="MACD"><div class="ind-toggle"></div><span class="ind-name">MACD</span><span class="dm" data-i18n="ind_macd">指数平滑异同</span></div>
              <div class="ind-item" data-ind="KDJ"><div class="ind-toggle"></div><span class="ind-name">KDJ</span><span class="dm" data-i18n="ind_kdj">随机指标</span></div>
              <div class="ind-item" data-ind="ATR"><div class="ind-toggle"></div><span class="ind-name">ATR</span><span class="dm" data-i18n="ind_atr">真实波幅</span></div>
            </div>
          </div>
          <!-- Active indicator tags -->
          <span class="ind-tags" id="indTags"></span>

          <div class="vs"></div>

          <!-- Drawing tools trigger button (opens overlay on chart) -->
          <button class="dt-trigger" id="dtTrigger" onclick="toggleDrawTools()" data-i18n-title="dt_more"><svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"><line x1="1" y1="14" x2="11" y2="4"/><circle cx="11" cy="4" r="1.5" fill="currentColor" stroke="none"/><path d="M13.5 12.5l-2-2 1.2-1.2a.5.5 0 01.7 0l1.3 1.3a.5.5 0 010 .7L13.5 12.5z" fill="currentColor" stroke="none"/><line x1="11.5" y1="10.5" x2="13" y2="12"/></svg></button>

          <!-- Widget controls (right side) -->
          <div style="margin-left:auto;display:flex;gap:1px">
            <button class="dtb" data-i18n-title="wc_settings"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"><circle cx="7" cy="7" r="2.2"/><path d="M7 1.5v1.3M7 11.2v1.3M1.5 7h1.3M11.2 7h1.3M3.1 3.1l.9.9M10 10l.9.9M3.1 10.9l.9-.9M10 4l.9-.9"/></svg></button>
            <button class="dtb" data-i18n-title="wc_screenshot"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"><rect x="1.5" y="3" width="11" height="8.5" rx="1.5"/><circle cx="7" cy="7.5" r="2"/><circle cx="10" cy="4.8" r=".6" fill="currentColor"/></svg></button>
            <button class="dtb" data-i18n-title="wc_fullscreen"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"><polyline points="1.5,5 1.5,1.5 5,1.5"/><polyline points="9,1.5 12.5,1.5 12.5,5"/><polyline points="12.5,9 12.5,12.5 9,12.5"/><polyline points="5,12.5 1.5,12.5 1.5,9"/></svg></button>
          </div>
        </div>
      </div>

      <!-- Chart body -->
      <div class="kbody">
        <!-- Drawing tools overlay (floats on chart left edge) -->
        <div class="dt-overlay" id="dtOverlay">
          <button class="dtb" data-i18n-title="dt_trend"><svg viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><line x1="2" y1="12" x2="12" y2="2"/></svg></button>
          <button class="dtb" data-i18n-title="dt_hline"><svg viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><line x1="1" y1="7" x2="13" y2="7"/></svg></button>
          <button class="dtb" data-i18n-title="dt_rect"><svg viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"><rect x="2" y="3" width="10" height="8" rx="1"/></svg></button>
          <button class="dtb" data-i18n-title="dt_fib"><svg viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"><line x1="1" y1="2" x2="13" y2="2"/><line x1="1" y1="5.5" x2="13" y2="5.5" stroke-dasharray="2 1.5"/><line x1="1" y1="9" x2="13" y2="9" stroke-dasharray="2 1.5"/><line x1="1" y1="12" x2="13" y2="12"/></svg></button>
          <button class="dtb" data-i18n-title="dt_note"><svg viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"><line x1="7" y1="2" x2="7" y2="12"/><line x1="2" y1="7" x2="12" y2="7"/></svg></button>
          <button class="dtb" data-i18n-title="dt_more"><svg viewBox="0 0 14 14" fill="currentColor"><circle cx="3" cy="7" r="1.2"/><circle cx="7" cy="7" r="1.2"/><circle cx="11" cy="7" r="1.2"/></svg></button>
        </div>
        <div class="grd">
          <div class="gl" style="top:12%"><span class="gll">72,000</span></div>
          <div class="gl" style="top:30%"><span class="gll">70,000</span></div>
          <div class="gl" style="top:50%"><span class="gll">68,000</span></div>
          <div class="gl" style="top:70%"><span class="gll">66,000</span></div>
          <div class="gl" style="top:88%"><span class="gll">64,000</span></div>
        </div>
        <div class="candles" id="candles"></div>
        <div class="va" id="vol"></div>
        <div class="vpo" id="vpo"></div>
        
        <!-- WRB markers -->
        <div class="wrb" style="top:20%;left:28%;background:rgba(38,166,154,.2);color:var(--grn);border:1px solid rgba(38,166,154,.4)">▲ Bull</div>
        <div class="wrb" style="top:55%;left:62%;background:rgba(239,83,80,.2);color:var(--red);border:1px solid rgba(239,83,80,.4)">▼ Bear</div>
        <div class="wrb" style="top:35%;left:75%;background:rgba(38,166,154,.2);color:var(--grn);border:1px solid rgba(38,166,154,.4)">▲ Bull</div>

        <!-- POC label -->
        <div style="position:absolute;top:48%;right:50px;font-size:8px;color:var(--gld);font-weight:600;pointer-events:none">── POC 67,850</div>
        
        <!-- Current price line -->
        <div style="position:absolute;top:38%;left:35px;right:0;border-top:1px solid var(--grn);opacity:.5;pointer-events:none"></div>
        <div style="position:absolute;top:38%;right:0;background:var(--grn);color:#fff;font-size:8px;padding:1px 4px;font-family:monospace;font-weight:600;pointer-events:none">68,144</div>
      </div>
    </div>

    <!-- Resize -->
    <div class="rzh"></div>

    <!-- ═══ BOTTOM WIDGET GRID ═══ -->
    <div class="wg">

      <!-- Widget: Heatmap -->
      <div class="wp">
        <div class="wph">
          <div class="wph-title">HEATMAP</div>
          <div class="wph-sym">Crypto ▾</div>
          <div class="wph-spc"></div>
          <button class="wph-btn">⟲</button>
          <button class="wph-btn">⛶</button>
          <button class="wph-btn">✕</button>
        </div>
        <div class="wpb">
          <div class="hmg" id="hm"></div>
        </div>
      </div>

      <!-- Widget: Fundamentals -->
      <div class="wp">
        <div class="wph">
          <div class="wph-title">FUNDAMENTALS</div>
          <div class="wph-sym">AAPL ▾</div>
          <div class="wph-spc"></div>
          <button class="wph-btn">⟲</button>
          <button class="wph-btn">⛶</button>
          <button class="wph-btn">✕</button>
        </div>
        <div class="wpb">
          <div class="fg">
            <div class="fi"><span class="fl">P/E</span><span class="fv">33.2</span></div>
            <div class="fi"><span class="fl">P/B</span><span class="fv">62.8</span></div>
            <div class="fi"><span class="fl">MktCap</span><span class="fv up">3.45T</span></div>
            <div class="fi"><span class="fl">Rev</span><span class="fv">391B</span></div>
            <div class="fi"><span class="fl">EPS</span><span class="fv up">6.73</span></div>
            <div class="fi"><span class="fl">DivYield</span><span class="fv">0.44%</span></div>
            <div class="fi"><span class="fl">ROE</span><span class="fv up">171%</span></div>
            <div class="fi"><span class="fl">D/E</span><span class="fv">1.87</span></div>
            <div class="fi"><span class="fl">52W Hi</span><span class="fv">260</span></div>
            <div class="fi"><span class="fl">52W Lo</span><span class="fv">164</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ CHAT PANEL ═══ -->
  <div class="cp">
    <div class="ch">
      <div class="chtl"><div class="cdot"></div> GainLab AI</div>
      <button style="background:0;border:0;color:var(--t2);cursor:pointer;font-size:14px">✕</button>
    </div>
    <div class="cm">
      <div class="msg a" data-i18n="chat_welcome">Hi — 我可以帮你分析行情、生成图表。试试下面的快捷操作：</div>
      <div class="msg u" data-i18n="chat_q1">帮我看看 BTC 的筹码分布</div>
      <div class="msg a">
        <span data-i18n="chat_a1_title">BTC/USDT 筹码分析完成</span><br><br>
        <b>POC:</b> $67,850<br>
        <b>VAH:</b> $69,200 · <b>VAL:</b> $66,400<br><br>
        <span data-i18n="chat_a1_body">当前价在 POC 上方，多头占优。</span>
        <div class="tb" data-i18n="chat_a1_tool">volume_profile → K线已叠加</div>
      </div>
      <div class="msg u" data-i18n="chat_q2">对比 AAPL 和 MSFT</div>
      <div class="msg a">
        <span data-i18n="chat_a2">正在获取基本面数据...</span>
        <div class="tb">fundamentals ···</div>
      </div>
    </div>
    <div class="cqa">
      <div class="qa" data-i18n="qa_vp">BTC 筹码</div>
      <div class="qa" data-i18n="qa_hm">热力图</div>
      <div class="qa">AAPL K线</div>
      <div class="qa" data-i18n="qa_wrb">WRB 信号</div>
    </div>
    <div class="ci">
      <input type="text" data-i18n-ph="ph_chat" placeholder="输入指令或问题...">
      <button class="csb">↑</button>
    </div>
  </div>
</div>

<script>
function genCandles(){
  const el=document.getElementById('candles'),vol=document.getElementById('vol');
  let p=67000,h='',v='';
  for(let i=0;i<75;i++){
    p=Math.max(63500,Math.min(72000,p+(Math.random()-.48)*750));
    const o=p-400+Math.random()*800,c=p,hi=Math.max(o,c)+Math.random()*350,lo=Math.min(o,c)-Math.random()*350;
    const bull=c>=o,col=bull?'var(--grn)':'var(--red)';
    const t=((72000-hi)/8500)*100,b=((72000-lo)/8500)*100;
    const bt=((72000-Math.max(o,c))/8500)*100,bb=((72000-Math.min(o,c))/8500)*100;
    h+=`<div class="c"><div class="cw" style="top:${t}%;height:${b-t}%;background:${col}"></div><div class="cb" style="top:${bt}%;height:${Math.max(bb-bt,.5)}%;background:${col}"></div></div>`;
    v+=`<div class="vb" style="height:${Math.random()*32+4}px;background:${col}"></div>`;
  }
  el.innerHTML=h;vol.innerHTML=v;
}
function genVP(){
  const el=document.getElementById('vpo');
  const vs=[25,35,50,65,75,85,100,90,70,55,40,20];
  let h='';
  vs.forEach((v)=>{const b=Math.random()*.6+.2;
    h+=`<div class="vpb"><div class="vpbu" style="width:${v*b}%"></div><div class="vpse" style="width:${v*(1-b)}%"></div></div>`;
  });
  el.innerHTML=h;
}
function genHM(){
  const d=[{s:'BTC',p:2.3},{s:'ETH',p:1.8},{s:'SOL',p:5.2},{s:'BNB',p:-.4},{s:'XRP',p:-1.2},{s:'ADA',p:3.1},{s:'DOGE',p:8.4},{s:'AVAX',p:-2.1},{s:'DOT',p:.8},{s:'LINK',p:4.2},{s:'UNI',p:-.3},{s:'MATIC',p:1.5}];
  document.getElementById('hm').innerHTML=d.map(x=>{
    const g=x.p>=0,i=Math.min(Math.abs(x.p)/8,1),bg=g?`rgba(38,166,154,${.15+i*.4})`:`rgba(239,83,80,${.15+i*.4})`,tc=g?'var(--grn)':'var(--red)';
    return`<div class="hmc" style="background:${bg}"><span class="s" style="color:${tc}">${x.s}</span><span class="p" style="color:${tc}">${x.p>0?'+':''}${x.p}%</span></div>`;
  }).join('');
}
function toggleDD(){
  const dd=document.getElementById('dd'),ov=document.getElementById('ddOverlay');
  const open=!dd.classList.contains('show');
  dd.classList.toggle('show');ov.classList.toggle('show');
  if(open){const inp=document.getElementById('ddInput');inp.value='';inp.focus();filterDD('');}
}
function closeDD(e){
  if(e)e.stopPropagation();
  document.getElementById('dd').classList.remove('show');
  document.getElementById('ddOverlay').classList.remove('show');
}
function filterDD(q){
  q=q.toLowerCase();
  const dd=document.getElementById('dd');
  dd.querySelectorAll('.ddi').forEach(el=>{
    const t=(el.dataset.sym+' '+el.textContent).toLowerCase();
    el.style.display=t.includes(q)?'':'none';
  });
  dd.querySelectorAll('.dd-section').forEach(el=>{
    let next=el.nextElementSibling,vis=false;
    while(next&&!next.classList.contains('dd-section')){
      if(next.classList.contains('ddi')&&next.style.display!=='none')vis=true;
      next=next.nextElementSibling;
    }
    el.style.display=vis?'':'none';
  });
}
document.getElementById('ddInput')?.addEventListener('input',e=>filterDD(e.target.value));
document.querySelectorAll('.ddi').forEach(el=>el.addEventListener('click',function(e){
  e.stopPropagation();
  const sym=this.dataset.sym,mkt=this.dataset.mkt;
  document.querySelector('.sym-t').textContent=sym;
  document.querySelector('.sym-m').textContent=mkt;
  closeDD();genCandles();
}));
// === Indicator panel ===
function toggleInd(){
  const p=document.getElementById('indPanel'),o=document.getElementById('indOverlay');
  const open=!p.classList.contains('show');
  p.classList.toggle('show');o.classList.toggle('show');
  if(open){const inp=document.getElementById('indInput');inp.value='';inp.focus();filterInd('');}
}
function closeInd(e){
  if(e)e.stopPropagation();
  document.getElementById('indPanel').classList.remove('show');
  document.getElementById('indOverlay').classList.remove('show');
}
function filterInd(q){
  q=q.toLowerCase();
  const panel=document.getElementById('indPanel');
  panel.querySelectorAll('.ind-item').forEach(el=>{
    const t=(el.dataset.ind+' '+el.textContent).toLowerCase();
    el.style.display=t.includes(q)?'':'none';
  });
  panel.querySelectorAll('.dd-section').forEach(el=>{
    let next=el.nextElementSibling,vis=false;
    while(next&&!next.classList.contains('dd-section')){
      if(next.classList.contains('ind-item')&&next.style.display!=='none')vis=true;
      next=next.nextElementSibling;
    }
    el.style.display=vis?'':'none';
  });
}
document.getElementById('indInput')?.addEventListener('input',e=>filterInd(e.target.value));
document.querySelectorAll('.ind-item').forEach(el=>el.addEventListener('click',function(e){
  e.stopPropagation();
  this.classList.toggle('on');
  updateIndTags();
}));
function updateIndTags(){
  const active=[];
  document.querySelectorAll('.ind-item.on').forEach(el=>active.push(el.dataset.ind));
  document.querySelector('.ind-count').textContent=active.length;
  document.getElementById('indTags').innerHTML=active.map(n=>`<span class="ind-tag">${n}</span>`).join('');
}
updateIndTags();

// === Period: common shortcuts + full dropdown (dash.gainlab style) ===
const allPeriods=[
  {name:'1m',common:false},{name:'5m',common:false},{name:'15m',common:false},{name:'30m',common:false},
  {name:'1H',common:true},{name:'4H',common:true},{name:'1D',common:true},
  {name:'1W',common:false},{name:'1M',common:false}
];
let activePeriod='1D';

function renderPdCommons(){
  const box=document.getElementById('pdCommons');
  box.innerHTML=allPeriods.filter(p=>p.common).map(p=>
    `<button class="pb${p.name===activePeriod?' on':''}" onclick="setPeriod('${p.name}')">${p.name}</button>`
  ).join('');
  // dropdown button shows current period if not in commons
  const btn=document.getElementById('pdDdBtn');
  const inCommons=allPeriods.some(p=>p.common&&p.name===activePeriod);
  btn.innerHTML=`<span>${inCommons?'':activePeriod+' '}</span><svg viewBox="0 0 10 6" width="8" height="5" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="1,1 5,5 9,1"/></svg>`;
}
function renderPdDropdown(){
  const dd=document.getElementById('pdDd');
  dd.innerHTML=allPeriods.map(p=>{
    const starSvg=p.common
      ?'<svg viewBox="0 0 12 12" width="12" height="12" fill="currentColor"><path d="M6 1l1.5 3.1 3.4.5-2.5 2.4.6 3.4L6 8.7 3 10.4l.6-3.4L1.1 4.6l3.4-.5z"/></svg>'
      :'<svg viewBox="0 0 12 12" width="12" height="12" fill="none" stroke="currentColor" stroke-width="1"><path d="M6 1l1.5 3.1 3.4.5-2.5 2.4.6 3.4L6 8.7 3 10.4l.6-3.4L1.1 4.6l3.4-.5z"/></svg>';
    return `<div class="pd-item${p.name===activePeriod?' active':''}">
      <span class="pd-name" onclick="setPeriod('${p.name}')">${p.name}</span>
      <button class="pd-star${p.common?' on':''}" onclick="event.stopPropagation();toggleCommon('${p.name}')">${starSvg}</button>
    </div>`;
  }).join('');
}
function setPeriod(name){
  activePeriod=name;
  renderPdCommons();closePdDd();genCandles();
}
function toggleCommon(name){
  const p=allPeriods.find(x=>x.name===name);
  if(!p)return;
  const commonCount=allPeriods.filter(x=>x.common).length;
  if(p.common){p.common=false;}
  else if(commonCount<5){p.common=true;}
  renderPdCommons();renderPdDropdown();
}
function togglePdDd(){
  const dd=document.getElementById('pdDd'),bg=document.getElementById('pdDdBg');
  const show=!dd.classList.contains('show');
  dd.classList.toggle('show',show);bg.classList.toggle('show',show);
  if(show)renderPdDropdown();
}
function closePdDd(){
  document.getElementById('pdDd').classList.remove('show');
  document.getElementById('pdDdBg').classList.remove('show');
}
renderPdCommons();

// === Chart type: icon + dropdown (dash.gainlab style) ===
const chartTypes=[
  {id:'candle_solid',nameKey:'ct_candle_solid',
   icon:'<path d="M7 1h2v3h2v8H5V4h2V1zm0 14h2v-2H7v2z"/>'},
  {id:'candle_stroke',nameKey:'ct_candle_hollow',
   icon:'<rect x="5" y="4" width="6" height="8" rx=".5" fill="none" stroke="currentColor" stroke-width="1.2"/><line x1="8" y1="1" x2="8" y2="4" stroke="currentColor" stroke-width="1.2"/><line x1="8" y1="12" x2="8" y2="15" stroke="currentColor" stroke-width="1.2"/>'},
  {id:'ohlc',nameKey:'ct_ohlc',
   icon:'<line x1="4" y1="2" x2="4" y2="14" stroke="currentColor" stroke-width="1.3"/><line x1="1" y1="5" x2="4" y2="5" stroke="currentColor" stroke-width="1.3"/><line x1="4" y1="11" x2="7" y2="11" stroke="currentColor" stroke-width="1.3"/><line x1="11" y1="4" x2="11" y2="14" stroke="currentColor" stroke-width="1.3"/><line x1="8" y1="7" x2="11" y2="7" stroke="currentColor" stroke-width="1.3"/><line x1="11" y1="12" x2="14" y2="12" stroke="currentColor" stroke-width="1.3"/>'},
  {id:'price_line',nameKey:'ct_line',
   icon:'<polyline points="1,12 4,7 8,9 12,3 15,6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>'},
  {id:'area',nameKey:'ct_area',
   icon:'<path d="M1,12 L4,7 L8,9 L12,3 L15,6 L15,14 L1,14 Z" opacity=".3"/><polyline points="1,12 4,7 8,9 12,3 15,6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>'}
];
let curChartType='candle_solid';

function renderCtIcon(){
  const ct=chartTypes.find(c=>c.id===curChartType);
  document.getElementById('ctIcon').innerHTML=ct.icon;
}
function renderCtDropdown(){
  const dd=document.getElementById('ctDd');
  dd.innerHTML=chartTypes.map(ct=>
    `<div class="pd-item${ct.id===curChartType?' active':''}" onclick="setChartType('${ct.id}')">
      <svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor" style="flex-shrink:0">${ct.icon}</svg>
      <span class="pd-name">${t(ct.nameKey)}</span>
    </div>`
  ).join('');
}
function setChartType(id){
  curChartType=id;renderCtIcon();closeCtDd();genCandles();
}
function toggleCtDd(){
  const dd=document.getElementById('ctDd'),bg=document.getElementById('ctDdBg');
  const show=!dd.classList.contains('show');
  dd.classList.toggle('show',show);bg.classList.toggle('show',show);
  if(show)renderCtDropdown();
}
function closeCtDd(){
  document.getElementById('ctDd').classList.remove('show');
  document.getElementById('ctDdBg').classList.remove('show');
}
renderCtIcon();

genCandles();genVP();genHM();

// ═══ SIDEBAR (single panel, Koyfin style) ═══
const sidebarItems=[
  // Each item: {section, nameKey, icon(svg string), badge, id}
  {sectionKey:'sec_charts'},
  {id:'kline',nameKey:'it_kline',badge:'CK',on:true,
   svg:'<svg viewBox="0 0 16 16" fill="currentColor"><rect x="1" y="9" width="3" height="6" rx=".5"/><rect x="5.5" y="5" width="3" height="10" rx=".5"/><rect x="10" y="1" width="3" height="14" rx=".5"/></svg>'},
  {id:'tick',nameKey:'it_tick',badge:'TK',
   svg:'<svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="1,12 4,8 7,10 10,4 13,6 15,2"/></svg>'},
  {id:'depth',nameKey:'it_depth',badge:'DP',
   svg:'<svg viewBox="0 0 16 16" fill="currentColor" opacity=".85"><path d="M1 14V8l3-1 3 2 3-4 4-2v11z" opacity=".3"/><path d="M1 14V10l3 1 3-3 3 2 4-4v8z" opacity=".5"/></svg>'},
  {sectionKey:'sec_heatmap'},
  {id:'heatmap',nameKey:'it_crypto',badge:'HM',
   svg:'<svg viewBox="0 0 16 16" fill="currentColor"><rect x="1" y="1" width="6.5" height="6.5" rx="1"/><rect x="8.5" y="1" width="6.5" height="6.5" rx="1" opacity=".5"/><rect x="1" y="8.5" width="6.5" height="6.5" rx="1" opacity=".5"/><rect x="8.5" y="8.5" width="6.5" height="6.5" rx="1" opacity=".3"/></svg>'},
  {id:'sector',nameKey:'it_sector',badge:'SC',
   svg:'<svg viewBox="0 0 16 16" fill="currentColor"><rect x="1" y="1" width="4" height="4" rx=".5"/><rect x="6" y="1" width="4" height="4" rx=".5" opacity=".7"/><rect x="11" y="1" width="4" height="4" rx=".5" opacity=".4"/><rect x="1" y="6" width="4" height="4" rx=".5" opacity=".7"/><rect x="6" y="6" width="4" height="4" rx=".5" opacity=".5"/><rect x="11" y="6" width="4" height="4" rx=".5" opacity=".3"/><rect x="1" y="11" width="14" height="4" rx=".5" opacity=".2"/></svg>'},
  {id:'rank',nameKey:'it_rank',badge:'GL',
   svg:'<svg viewBox="0 0 16 16" fill="currentColor"><path d="M4 2l2.5 4H1.5L4 2z" opacity=".8"/><path d="M12 14l-2.5-4h5L12 14z" opacity=".5"/><rect x="7" y="6" width="2" height="4" rx=".5" opacity=".4"/></svg>'},
  {sectionKey:'sec_fund'},
  {id:'fund',nameKey:'it_overview',badge:'FD',
   svg:'<svg viewBox="0 0 16 16" fill="currentColor"><path d="M3 1h10a1 1 0 011 1v12a1 1 0 01-1 1H3a1 1 0 01-1-1V2a1 1 0 011-1zm1 3h8v1.5H4V4zm0 3h5v1.5H4V7zm0 3h7v1.5H4V10z"/></svg>'},
  {id:'compare',nameKey:'it_compare',badge:'CMP',
   svg:'<svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="1" y="1" width="9" height="9" rx="1.5"/><rect x="6" y="6" width="9" height="9" rx="1.5"/></svg>'},
  {sep:true},
  {sectionKey:'sec_other'},
  {id:'ai',nameKey:'it_chat_panel',badge:'AI',
   svg:'<svg viewBox="0 0 16 16" fill="currentColor"><path d="M2 2h12a1 1 0 011 1v8a1 1 0 01-1 1H5l-3 3V3a1 1 0 011-1z"/></svg>'},
  {id:'analysis',nameKey:'it_ai_analysis',
   svg:'<svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><circle cx="8" cy="8" r="5.5"/><path d="M8 5v3l2 1.5"/></svg>'},
  {id:'report',nameKey:'it_report',
   svg:'<svg viewBox="0 0 16 16" fill="currentColor"><path d="M4 1h5l4 4v9a1 1 0 01-1 1H4a1 1 0 01-1-1V2a1 1 0 011-1zm4.5.5V5H12"/><rect x="5" y="7" width="6" height="1" rx=".3"/><rect x="5" y="9.5" width="4" height="1" rx=".3"/></svg>'},
];

function renderSidebar(){
  const nav=document.getElementById('sbNav');
  nav.innerHTML=sidebarItems.map(item=>{
    if(item.sep)return'<div class="sb-sep"></div>';
    if(item.sectionKey)return`<div class="sb-section">${t(item.sectionKey)}</div>`;
    const badge=item.badge?`<span class="sb-badge">${item.badge}</span>`:'';
    const cls=item.on?'sb-item on':'sb-item';
    return`<div class="${cls}" data-id="${item.id}">
      <div class="sb-ico">${item.svg}</div>
      <span class="sb-text">${t(item.nameKey)}</span>
      ${badge}
      <span class="sb-tip">${t(item.nameKey)}</span>
    </div>`;
  }).join('');
  // Click handlers
  nav.querySelectorAll('.sb-item').forEach(el=>el.addEventListener('click',function(){
    nav.querySelectorAll('.sb-item').forEach(e=>e.classList.remove('on'));
    this.classList.add('on');
  }));
}

let sidebarOpen=false;
function toggleSidebar(){
  sidebarOpen=!sidebarOpen;
  document.getElementById('sidebar').classList.toggle('open',sidebarOpen);
}

// renderSidebar() called after i18n init below

// ═══ i18n SYSTEM ═══
const i18n={
  zh:{
    // Header pills
    pill_ashare:'A股', pill_metal:'贵金属',
    // Sidebar tooltips
    sb_charts:'图表', sb_heatmap:'热力图', sb_fund:'基本面',
    sb_overlay:'叠加对比', sb_ai:'AI 对话', sb_add:'添加 Widget',
    // Indicator
    ind_label:'指标',
    ind_main_overlay:'主图叠加', ind_sub_panel:'副图指标',
    ind_ma:'移动平均线', ind_ema:'指数移动平均', ind_boll:'布林带',
    ind_vwap:'成交量加权均价', ind_vp:'筹码分布', ind_wrb:'宽幅K线信号',
    ind_rsi:'相对强弱', ind_macd:'指数平滑异同', ind_kdj:'随机指标', ind_atr:'真实波幅',
    // Drawing tools
    // Chart type
    ct_candle_solid:'实心蜡烛', ct_candle_hollow:'空心蜡烛', ct_ohlc:'OHLC', ct_line:'价格线', ct_area:'价格区域',
    // Drawing tools
    dt_trend:'趋势线', dt_hline:'水平线', dt_rect:'矩形',
    dt_fib:'斐波那契', dt_note:'标注', dt_more:'更多画图',
    // Widget controls
    wc_settings:'设置', wc_screenshot:'截图', wc_fullscreen:'全屏',
    // Placeholders
    ph_sym_search:'搜索标的...', ph_ind_search:'搜索指标...', ph_chat:'输入指令或问题...',
    // Chat
    chat_welcome:'Hi — 我可以帮你分析行情、生成图表。试试下面的快捷操作：',
    chat_q1:'帮我看看 BTC 的筹码分布',
    chat_a1_title:'BTC/USDT 筹码分析完成',
    chat_a1_body:'当前价在 POC 上方，多头占优。',
    chat_a1_tool:'volume_profile → K线已叠加',
    chat_q2:'对比 AAPL 和 MSFT',
    chat_a2:'正在获取基本面数据...',
    qa_vp:'BTC 筹码', qa_hm:'热力图', qa_wrb:'WRB 信号',
    // Sub-panel titles
    sp_charts:'图表', sp_heatmap:'热力图', sp_fund:'基本面',
    sp_overlay:'叠加对比', sp_ai:'AI 助手', sp_all:'所有组件',
    // Sub-panel sections & items
    sec_candle:'蜡烛图', sec_trend:'走势', sec_market:'市场', sec_macro:'宏观',
    sec_valuation:'估值', sec_finance:'财务', sec_news:'资讯',
    sec_compare:'对比', sec_interact:'交互', sec_output:'输出',
    sec_charts:'图表', sec_heatmap:'热力图', sec_fund:'基本面', sec_other:'其他',
    it_kline:'K线图', it_ha:'Heikin-Ashi', it_renko:'Renko',
    it_tick:'分时图', it_depth:'深度图',
    it_crypto:'Crypto', it_sector:'板块', it_rank:'涨跌幅排行', it_global:'全球市场',
    it_overview:'财务概览', it_compare:'财报对比', it_cashflow:'现金流', it_news:'新闻摘要',
    it_multi:'多资产叠加', it_corr:'相关性矩阵', it_ratio:'比率图',
    it_chat_panel:'对话面板', it_ai_analysis:'智能分析', it_report:'研报生成',
  },
  en:{
    pill_ashare:'A-Share', pill_metal:'Metals',
    sb_charts:'Charts', sb_heatmap:'Heatmap', sb_fund:'Fundamentals',
    sb_overlay:'Overlay', sb_ai:'AI Chat', sb_add:'Add Widget',
    ind_label:'Indicators',
    ind_main_overlay:'Main Overlay', ind_sub_panel:'Sub-chart',
    ind_ma:'Moving Average', ind_ema:'Exp. Moving Avg', ind_boll:'Bollinger Bands',
    ind_vwap:'Vol-Weighted Avg Price', ind_vp:'Volume Profile', ind_wrb:'Wide Range Bar',
    ind_rsi:'Relative Strength', ind_macd:'MACD', ind_kdj:'Stochastic', ind_atr:'Avg True Range',
    ct_candle_solid:'Candlestick', ct_candle_hollow:'Hollow Candle', ct_ohlc:'OHLC', ct_line:'Price Line', ct_area:'Price Area',
    dt_trend:'Trend Line', dt_hline:'Horizontal Line', dt_rect:'Rectangle',
    dt_fib:'Fibonacci', dt_note:'Annotate', dt_more:'More Tools',
    wc_settings:'Settings', wc_screenshot:'Screenshot', wc_fullscreen:'Fullscreen',
    ph_sym_search:'Search symbol...', ph_ind_search:'Search indicator...', ph_chat:'Enter command or question...',
    chat_welcome:'Hi — I can help you analyze markets and generate charts. Try these quick actions:',
    chat_q1:'Show me BTC volume profile',
    chat_a1_title:'BTC/USDT volume profile complete',
    chat_a1_body:'Price above POC — bulls in control.',
    chat_a1_tool:'volume_profile → overlaid on chart',
    chat_q2:'Compare AAPL vs MSFT',
    chat_a2:'Fetching fundamentals data...',
    qa_vp:'BTC Profile', qa_hm:'Heatmap', qa_wrb:'WRB Signals',
    sp_charts:'Charts', sp_heatmap:'Heatmap', sp_fund:'Fundamentals',
    sp_overlay:'Overlay', sp_ai:'AI Assistant', sp_all:'All Widgets',
    sec_candle:'Candlestick', sec_trend:'Trend', sec_market:'Markets', sec_macro:'Macro',
    sec_valuation:'Valuation', sec_finance:'Financials', sec_news:'News',
    sec_compare:'Compare', sec_interact:'Interact', sec_output:'Output',
    sec_charts:'Charts', sec_heatmap:'Heatmap', sec_fund:'Fundamentals', sec_other:'Other',
    it_kline:'Candlestick', it_ha:'Heikin-Ashi', it_renko:'Renko',
    it_tick:'Tick Chart', it_depth:'Depth Chart',
    it_crypto:'Crypto', it_sector:'Sectors', it_rank:'Gainers/Losers', it_global:'Global Markets',
    it_overview:'Financial Overview', it_compare:'Earnings Compare', it_cashflow:'Cash Flow', it_news:'News Feed',
    it_multi:'Multi-Asset Overlay', it_corr:'Correlation Matrix', it_ratio:'Ratio Chart',
    it_chat_panel:'Chat Panel', it_ai_analysis:'AI Analysis', it_report:'Research Report',
  }
};
let curLang='zh';

function t(key){return i18n[curLang][key]||key;}

// Now safe to render sidebar (depends on t())
renderSidebar();

// ═══ DRAWING TOOLS OVERLAY ═══
let dtOpen=false;
function toggleDrawTools(){
  dtOpen=!dtOpen;
  document.getElementById('dtOverlay').classList.toggle('show',dtOpen);
  document.getElementById('dtTrigger').classList.toggle('on',dtOpen);
}
// Click tool → highlight it
document.querySelectorAll('#dtOverlay .dtb').forEach(btn=>btn.addEventListener('click',function(){
  document.querySelectorAll('#dtOverlay .dtb').forEach(b=>b.classList.remove('on'));
  this.classList.add('on');
}));

function applyLang(){
  // Text content
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const k=el.dataset.i18n;
    if(i18n[curLang][k])el.textContent=i18n[curLang][k];
  });
  // Placeholders
  document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
    const k=el.dataset.i18nPh;
    if(i18n[curLang][k])el.placeholder=i18n[curLang][k];
  });
  // Titles (tooltips)
  document.querySelectorAll('[data-i18n-title]').forEach(el=>{
    const k=el.dataset.i18nTitle;
    if(i18n[curLang][k])el.title=i18n[curLang][k];
  });
  // Lang button
  document.getElementById('langBtn').textContent=curLang==='zh'?'EN':'中';
  // Re-render sidebar nav + period + chart type
  renderSidebar();
  renderPdCommons();
  renderCtIcon();
}

function toggleLang(){
  curLang=curLang==='zh'?'en':'zh';
  applyLang();
}
</script>
</body>
</html>
