import{j as e}from"./mosaic-86Umg_jF.js";import{a as p}from"./echarts-DW2iXprX.js";function C({toolCall:a}){const[s,r]=p.useState(!1),n=Object.entries(a.args).slice(0,2).map(([u,c])=>`${u}: ${String(c)}`).join(", ");return e.jsxs("div",{style:{marginTop:4,marginBottom:2},children:[e.jsxs("button",{onClick:()=>r(u=>!u),style:{display:"inline-flex",alignItems:"center",gap:4,padding:"2px 8px",borderRadius:12,border:"1px solid #7c3aed",background:"rgba(124,58,237,0.15)",color:"#c4b5fd",fontSize:11,cursor:"pointer",lineHeight:"1.4",fontFamily:"inherit"},children:[e.jsx("span",{children:"üîß"}),e.jsx("span",{style:{fontWeight:600},children:a.name}),n&&e.jsxs("span",{style:{color:"#a78bfa",opacity:.85},children:["(",n,")"]}),e.jsx("span",{style:{opacity:.6,fontSize:10},children:s?"‚ñ≤":"‚ñº"})]}),s&&e.jsx("pre",{style:{margin:"4px 0 0 4px",padding:"6px 10px",borderRadius:6,background:"rgba(124,58,237,0.08)",border:"1px solid rgba(124,58,237,0.25)",color:"#c4b5fd",fontSize:11,lineHeight:1.5,overflowX:"auto",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:JSON.stringify(a.args,null,2)})]})}function v({messages:a,streaming:s}){const r=p.useRef(null);return p.useEffect(()=>{r.current?.scrollIntoView({behavior:"smooth"})},[a]),a.length===0?e.jsx("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",color:"#3a3a6a",fontSize:14,padding:24,textAlign:"center",lineHeight:1.7},children:e.jsxs("span",{children:["üí° ‰Ω†Â•ΩÔºÅÊàëÊòØ GainLab AI",e.jsx("br",{}),"ÂêëÊàëÊèêÈóÆÂÖ≥‰∫éÂä†ÂØÜË¥ßÂ∏ÅÂ∏ÇÂú∫ÁöÑÈóÆÈ¢ò"]})}):e.jsxs("div",{style:{flex:1,overflowY:"auto",padding:"12px 12px 4px",display:"flex",flexDirection:"column",gap:8},children:[a.map(n=>e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:n.role==="user"?"flex-end":"flex-start"},children:[n.toolCalls&&n.toolCalls.length>0&&e.jsx("div",{style:{marginBottom:4,maxWidth:"90%"},children:n.toolCalls.map(u=>e.jsx(C,{toolCall:u},u.id))}),n.content&&e.jsx("div",{style:{maxWidth:"85%",padding:"8px 12px",borderRadius:n.role==="user"?"16px 16px 4px 16px":"16px 16px 16px 4px",background:n.role==="user"?"linear-gradient(135deg, #2563eb, #1d4ed8)":"#1a1a35",color:n.role==="user"?"#fff":"#c8c8e8",fontSize:13,lineHeight:1.6,border:n.role==="user"?"none":"1px solid #2a2a4a",wordBreak:"break-word",whiteSpace:"pre-wrap"},children:n.content})]},n.id)),s&&e.jsx("div",{style:{display:"flex",alignItems:"flex-start"},children:e.jsx("div",{style:{padding:"8px 14px",borderRadius:"16px 16px 16px 4px",background:"#1a1a35",border:"1px solid #2a2a4a",color:"#6a6aaa",fontSize:13},children:e.jsx("span",{style:{animation:"pulse 1s infinite"},children:"‚óè‚óè‚óè"})})}),e.jsx("div",{ref:r})]})}const R="https://gainlab-api.asher-sun.workers.dev/api/chat";function I(a){return a.replace(/<think>[\s\S]*?<\/think>/g,"").trim()}const j=20;async function*T(a){const s=a.length>j?a.slice(a.length-j):a;let r={};try{r=JSON.parse(localStorage.getItem("gainlab-agent")||"{}")}catch{}const n=localStorage.getItem("gainlab-lang")||"zh",u=r.endpoint||R;let c;try{c=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:s,config:{model:r.model,style:r.style,lang:n}})})}catch(x){yield{type:"error",error:`ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•: ${String(x)}`};return}if(!c.ok){yield{type:"error",error:`ÊúçÂä°Âô®ÈîôËØØ: ${c.status} ${c.statusText}`};return}const l=c.body;if(!l){yield{type:"error",error:"ÂìçÂ∫î‰Ωì‰∏∫Á©∫"};return}const f=l.getReader(),m=new TextDecoder;let y="";try{for(;;){const{done:x,value:h}=await f.read();if(x)break;y+=m.decode(h,{stream:!0});const d=y.split(`
`);y=d.pop()??"";for(const b of d){const S=b.trim();if(!S||!S.startsWith("data: "))continue;const t=S.slice(6);if(t==="[DONE]"){yield{type:"done"};return}let i;try{i=JSON.parse(t)}catch{continue}const o=i.type;if(console.log("[SSE] event:",o,o==="tool_result"?{widgetState:i.widgetState}:""),o==="text_delta"){const g=i.text??"",k=I(g);k&&(yield{type:"text_delta",text:k})}else if(o==="tool_call"){const g=i.tool;g&&(yield{type:"tool_call",toolCall:{id:g.id??"",name:g.name??"",args:g.arguments??{}}})}else o==="tool_result"?yield{type:"tool_result",result:i.result,widgetState:i.widgetState}:o==="error"&&(yield{type:"error",error:i.message??"Êú™Áü•ÈîôËØØ"})}}}finally{f.releaseLock()}yield{type:"done"}}let _=0;function w(){return`msg_${++_}_${Date.now()}`}function z(){const[a,s]=p.useState([]),[r,n]=p.useState(!1),[u,c]=p.useState(null),l=p.useRef([]),f=p.useRef(null),m=p.useCallback(async(x,h)=>{if(r||!x.trim())return;const d={id:w(),role:"user",content:x.trim()};s(t=>[...t,d]),l.current=[...l.current,{role:"user",content:x.trim()}];const b=w(),S={id:b,role:"assistant",content:"",toolCalls:[]};s(t=>[...t,S]),n(!0),c(null),f.current=null;try{for await(const t of T(l.current))if(t.type==="text_delta"&&t.text)s(i=>i.map(o=>o.id===b?{...o,content:o.content+(t.text??"")}:o));else if(t.type==="tool_call"&&t.toolCall){const i=t.toolCall;f.current=i,c(i),s(o=>o.map(g=>g.id===b?{...g,toolCalls:[...g.toolCalls??[],i]}:g))}else if(t.type==="tool_result"&&t.result!==void 0)console.log("[MCP] tool_result received",{hasToolCall:!!f.current,hasCallback:!!h,widgetState:t.widgetState}),f.current&&h&&h(f.current.name,t.result,t.widgetState),f.current=null,c(null);else{if(t.type==="done")break;if(t.type==="error"){s(i=>i.map(o=>o.id===b?{...o,content:o.content+(o.content?`
`:"")+`‚ùå ${t.error??"ËØ∑Ê±ÇÂ§±Ë¥•"}`}:o));break}}s(t=>{const i=t.find(o=>o.id===b);return i?.content&&(l.current=[...l.current,{role:"assistant",content:i.content}]),t})}finally{n(!1),c(null),f.current=null}},[r]),y=p.useCallback(()=>{s([]),l.current=[]},[]);return{messages:a,streaming:r,activeToolCall:u,sendMessage:m,clearMessages:y}}function D({onToolResult:a,onClose:s}){const[r,n]=p.useState(""),u=p.useRef(null),{messages:c,streaming:l,activeToolCall:f,sendMessage:m,clearMessages:y}=z(),x=p.useCallback(async()=>{const d=r.trim();!d||l||(n(""),await m(d,a),u.current?.focus())},[r,l,m,a]),h=p.useCallback(d=>{d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),x())},[x]);return e.jsxs("div",{style:{width:"100%",height:"100%",display:"flex",flexDirection:"column",background:"#0d0d20",borderLeft:"1px solid #1e1e3a",overflow:"hidden"},children:[e.jsxs("div",{style:{padding:"10px 14px",borderBottom:"1px solid #1e1e3a",display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0},children:[e.jsx("span",{style:{color:"#8888cc",fontSize:13,fontWeight:600},children:"‚ú® GainLab AI"}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:4},children:[e.jsx("button",{onClick:y,style:{background:"none",border:"none",color:"#4a4a7a",fontSize:11,cursor:"pointer",padding:"2px 6px",borderRadius:4},title:"Ê∏ÖÁ©∫ÂØπËØù",children:"Ê∏ÖÁ©∫"}),s&&e.jsx("button",{onClick:s,style:{background:"none",border:"none",color:"#4a4a7a",fontSize:14,cursor:"pointer",padding:"2px 6px",borderRadius:4,lineHeight:1},title:"Êî∂Ëµ∑",children:"‚úï"})]})]}),e.jsx(v,{messages:c,streaming:l}),f&&e.jsxs("div",{style:{padding:"4px 12px",background:"rgba(124,58,237,0.1)",borderTop:"1px solid rgba(124,58,237,0.2)",color:"#a78bfa",fontSize:11,flexShrink:0},children:["üîß Ê≠£Âú®Ë∞ÉÁî® ",f.name,"..."]}),e.jsxs("div",{style:{padding:"10px 12px",borderTop:"1px solid #1e1e3a",display:"flex",gap:8,alignItems:"flex-end",flexShrink:0},children:[e.jsx("textarea",{ref:u,value:r,onChange:d=>n(d.target.value),onKeyDown:h,disabled:l,placeholder:l?"Ê≠£Âú®ÂõûÂ§ç‰∏≠...":"ÂèëÊ∂àÊÅØÔºàEnter ÂèëÈÄÅÔºåShift+Enter Êç¢Ë°åÔºâ",rows:1,style:{flex:1,background:"#13132a",border:"1px solid #2a2a4a",borderRadius:8,color:"#d0d0f0",fontSize:13,padding:"8px 10px",resize:"none",outline:"none",fontFamily:"inherit",lineHeight:1.5,maxHeight:120,overflowY:"auto",transition:"border-color 0.15s",opacity:l?.6:1},onFocus:d=>{d.currentTarget.style.borderColor="#4a4a8a"},onBlur:d=>{d.currentTarget.style.borderColor="#2a2a4a"}}),e.jsx("button",{onClick:x,disabled:l||!r.trim(),style:{padding:"8px 14px",borderRadius:8,border:"none",background:l||!r.trim()?"#1e1e3a":"linear-gradient(135deg, #2563eb, #1d4ed8)",color:l||!r.trim()?"#3a3a6a":"#fff",fontSize:13,cursor:l||!r.trim()?"not-allowed":"pointer",flexShrink:0,transition:"all 0.15s",fontFamily:"inherit"},children:"ÂèëÈÄÅ"})]})]})}export{D as ChatPanel};
