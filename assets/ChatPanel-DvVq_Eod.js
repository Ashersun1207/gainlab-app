import{j as e}from"./mosaic-86Umg_jF.js";import{a as p}from"./echarts-DW2iXprX.js";function v({toolCall:l}){const[s,d]=p.useState(!1),t=Object.entries(l.args).slice(0,2).map(([u,c])=>`${u}: ${String(c)}`).join(", ");return e.jsxs("div",{style:{marginTop:4,marginBottom:2},children:[e.jsxs("button",{onClick:()=>d(u=>!u),style:{display:"inline-flex",alignItems:"center",gap:4,padding:"2px 8px",borderRadius:12,border:"1px solid #7c3aed",background:"rgba(124,58,237,0.15)",color:"#c4b5fd",fontSize:11,cursor:"pointer",lineHeight:"1.4",fontFamily:"inherit"},children:[e.jsx("span",{children:"üîß"}),e.jsx("span",{style:{fontWeight:600},children:l.name}),t&&e.jsxs("span",{style:{color:"#a78bfa",opacity:.85},children:["(",t,")"]}),e.jsx("span",{style:{opacity:.6,fontSize:10},children:s?"‚ñ≤":"‚ñº"})]}),s&&e.jsx("pre",{style:{margin:"4px 0 0 4px",padding:"6px 10px",borderRadius:6,background:"rgba(124,58,237,0.08)",border:"1px solid rgba(124,58,237,0.25)",color:"#c4b5fd",fontSize:11,lineHeight:1.5,overflowX:"auto",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:JSON.stringify(l.args,null,2)})]})}function w({messages:l,streaming:s}){const d=p.useRef(null);return p.useEffect(()=>{d.current?.scrollIntoView({behavior:"smooth"})},[l]),l.length===0?e.jsx("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",color:"#3a3a6a",fontSize:14,padding:24,textAlign:"center",lineHeight:1.7},children:e.jsxs("span",{children:["üí° ‰Ω†Â•ΩÔºÅÊàëÊòØ GainLab AI",e.jsx("br",{}),"ÂêëÊàëÊèêÈóÆÂÖ≥‰∫éÂä†ÂØÜË¥ßÂ∏ÅÂ∏ÇÂú∫ÁöÑÈóÆÈ¢ò"]})}):e.jsxs("div",{style:{flex:1,overflowY:"auto",padding:"12px 12px 4px",display:"flex",flexDirection:"column",gap:8},children:[l.map(t=>e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:t.role==="user"?"flex-end":"flex-start"},children:[t.toolCalls&&t.toolCalls.length>0&&e.jsx("div",{style:{marginBottom:4,maxWidth:"90%"},children:t.toolCalls.map(u=>e.jsx(v,{toolCall:u},u.id))}),t.content&&e.jsx("div",{style:{maxWidth:"85%",padding:"8px 12px",borderRadius:t.role==="user"?"16px 16px 4px 16px":"16px 16px 16px 4px",background:t.role==="user"?"linear-gradient(135deg, #2563eb, #1d4ed8)":"#1a1a35",color:t.role==="user"?"#fff":"#c8c8e8",fontSize:13,lineHeight:1.6,border:t.role==="user"?"none":"1px solid #2a2a4a",wordBreak:"break-word",whiteSpace:"pre-wrap"},children:t.content})]},t.id)),s&&e.jsx("div",{style:{display:"flex",alignItems:"flex-start"},children:e.jsx("div",{style:{padding:"8px 14px",borderRadius:"16px 16px 16px 4px",background:"#1a1a35",border:"1px solid #2a2a4a",color:"#6a6aaa",fontSize:13},children:e.jsx("span",{style:{animation:"pulse 1s infinite"},children:"‚óè‚óè‚óè"})})}),e.jsx("div",{ref:d})]})}const R="https://gainlab-api.asher-sun.workers.dev/api/chat";function I(l){return l.replace(/<think>[\s\S]*?<\/think>/g,"").trim()}const k=20;async function*T(l){const s=l.length>k?l.slice(l.length-k):l;let d={};try{d=JSON.parse(localStorage.getItem("gainlab-agent")||"{}")}catch{}const t=localStorage.getItem("gainlab-lang")||"zh",u=d.endpoint||R;let c;try{c=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:s,config:{model:d.model,style:d.style,lang:t}})})}catch(g){yield{type:"error",error:`ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•: ${String(g)}`};return}if(!c.ok){yield{type:"error",error:`ÊúçÂä°Âô®ÈîôËØØ: ${c.status} ${c.statusText}`};return}const f=c.body;if(!f){yield{type:"error",error:"ÂìçÂ∫î‰Ωì‰∏∫Á©∫"};return}const r=f.getReader(),b=new TextDecoder;let y="";try{for(;;){const{done:g,value:h}=await r.read();if(g)break;y+=b.decode(h,{stream:!0});const m=y.split(`
`);y=m.pop()??"";for(const o of m){const S=o.trim();if(!S||!S.startsWith("data: "))continue;const n=S.slice(6);if(n==="[DONE]"){yield{type:"done"};return}let i;try{i=JSON.parse(n)}catch{continue}const a=i.type;if(a==="text_delta"){const x=i.text??"",j=I(x);j&&(yield{type:"text_delta",text:j})}else if(a==="tool_call"){const x=i.tool;x&&(yield{type:"tool_call",toolCall:{id:x.id??"",name:x.name??"",args:x.arguments??{}}})}else a==="tool_result"?yield{type:"tool_result",result:i.result,widgetState:i.widgetState}:a==="error"&&(yield{type:"error",error:i.message??"Êú™Áü•ÈîôËØØ"})}}}finally{r.releaseLock()}yield{type:"done"}}let z=0;function C(){return`msg_${++z}_${Date.now()}`}function _(){const[l,s]=p.useState([]),[d,t]=p.useState(!1),[u,c]=p.useState(null),f=p.useRef([]),r=p.useRef(null),b=p.useCallback(async(g,h)=>{if(d||!g.trim())return;const m={id:C(),role:"user",content:g.trim()};s(n=>[...n,m]),f.current=[...f.current,{role:"user",content:g.trim()}];const o=C(),S={id:o,role:"assistant",content:"",toolCalls:[]};s(n=>[...n,S]),t(!0),c(null),r.current=null;try{for await(const n of T(f.current))if(n.type==="text_delta"&&n.text)s(i=>i.map(a=>a.id===o?{...a,content:a.content+(n.text??"")}:a));else if(n.type==="tool_call"&&n.toolCall){const i=n.toolCall;r.current=i,c(i),s(a=>a.map(x=>x.id===o?{...x,toolCalls:[...x.toolCalls??[],i]}:x))}else if(n.type==="tool_result"&&n.result!==void 0)r.current&&h&&h(r.current.name,n.result,n.widgetState),r.current=null,c(null);else{if(n.type==="done")break;if(n.type==="error"){s(i=>i.map(a=>a.id===o?{...a,content:a.content+(a.content?`
`:"")+`‚ùå ${n.error??"ËØ∑Ê±ÇÂ§±Ë¥•"}`}:a));break}}s(n=>{const i=n.find(a=>a.id===o);return i?.content&&(f.current=[...f.current,{role:"assistant",content:i.content}]),n})}finally{t(!1),c(null),r.current=null}},[d]),y=p.useCallback(()=>{s([]),f.current=[]},[]);return{messages:l,streaming:d,activeToolCall:u,sendMessage:b,clearMessages:y}}function D({onToolResult:l,onNewRound:s,onClose:d}){const[t,u]=p.useState(""),c=p.useRef(null),{messages:f,streaming:r,activeToolCall:b,sendMessage:y,clearMessages:g}=_(),h=p.useCallback(async()=>{const o=t.trim();!o||r||(u(""),s?.(),await y(o,l),c.current?.focus())},[t,r,y,l,s]),m=p.useCallback(o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),h())},[h]);return e.jsxs("div",{style:{width:"100%",height:"100%",display:"flex",flexDirection:"column",background:"#0d0d20",borderLeft:"1px solid #1e1e3a",overflow:"hidden"},children:[e.jsxs("div",{style:{padding:"10px 14px",borderBottom:"1px solid #1e1e3a",display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0},children:[e.jsx("span",{style:{color:"#8888cc",fontSize:13,fontWeight:600},children:"‚ú® GainLab AI"}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:4},children:[e.jsx("button",{onClick:g,style:{background:"none",border:"none",color:"#4a4a7a",fontSize:11,cursor:"pointer",padding:"2px 6px",borderRadius:4},title:"Ê∏ÖÁ©∫ÂØπËØù",children:"Ê∏ÖÁ©∫"}),d&&e.jsx("button",{onClick:d,style:{background:"none",border:"none",color:"#4a4a7a",fontSize:14,cursor:"pointer",padding:"2px 6px",borderRadius:4,lineHeight:1},title:"Êî∂Ëµ∑",children:"‚úï"})]})]}),e.jsx(w,{messages:f,streaming:r}),b&&e.jsxs("div",{style:{padding:"4px 12px",background:"rgba(124,58,237,0.1)",borderTop:"1px solid rgba(124,58,237,0.2)",color:"#a78bfa",fontSize:11,flexShrink:0},children:["üîß Ê≠£Âú®Ë∞ÉÁî® ",b.name,"..."]}),e.jsxs("div",{style:{padding:"10px 12px",borderTop:"1px solid #1e1e3a",display:"flex",gap:8,alignItems:"flex-end",flexShrink:0},children:[e.jsx("textarea",{ref:c,value:t,onChange:o=>u(o.target.value),onKeyDown:m,disabled:r,placeholder:r?"Ê≠£Âú®ÂõûÂ§ç‰∏≠...":"ÂèëÊ∂àÊÅØÔºàEnter ÂèëÈÄÅÔºåShift+Enter Êç¢Ë°åÔºâ",rows:1,style:{flex:1,background:"#13132a",border:"1px solid #2a2a4a",borderRadius:8,color:"#d0d0f0",fontSize:13,padding:"8px 10px",resize:"none",outline:"none",fontFamily:"inherit",lineHeight:1.5,maxHeight:120,overflowY:"auto",transition:"border-color 0.15s",opacity:r?.6:1},onFocus:o=>{o.currentTarget.style.borderColor="#4a4a8a"},onBlur:o=>{o.currentTarget.style.borderColor="#2a2a4a"}}),e.jsx("button",{onClick:h,disabled:r||!t.trim(),style:{padding:"8px 14px",borderRadius:8,border:"none",background:r||!t.trim()?"#1e1e3a":"linear-gradient(135deg, #2563eb, #1d4ed8)",color:r||!t.trim()?"#3a3a6a":"#fff",fontSize:13,cursor:r||!t.trim()?"not-allowed":"pointer",flexShrink:0,transition:"all 0.15s",fontFamily:"inherit"},children:"ÂèëÈÄÅ"})]})]})}export{D as ChatPanel};
