import{j as e}from"./mosaic-86Umg_jF.js";import{a}from"./echarts-DW2iXprX.js";import{W as R}from"./index-DLqq1hmS.js";function T({toolCall:n}){const[i,d]=a.useState(!1),t=Object.entries(n.args).slice(0,2).map(([c,s])=>`${c}: ${String(s)}`).join(", ");return e.jsxs("div",{style:{marginTop:4,marginBottom:2},children:[e.jsxs("button",{onClick:()=>d(c=>!c),style:{display:"inline-flex",alignItems:"center",gap:4,padding:"2px 8px",borderRadius:12,border:"1px solid #7c3aed",background:"rgba(124,58,237,0.15)",color:"#c4b5fd",fontSize:11,cursor:"pointer",lineHeight:"1.4",fontFamily:"inherit"},children:[e.jsx("span",{children:"üîß"}),e.jsx("span",{style:{fontWeight:600},children:n.name}),t&&e.jsxs("span",{style:{color:"#a78bfa",opacity:.85},children:["(",t,")"]}),e.jsx("span",{style:{opacity:.6,fontSize:10},children:i?"‚ñ≤":"‚ñº"})]}),i&&e.jsx("pre",{style:{margin:"4px 0 0 4px",padding:"6px 10px",borderRadius:6,background:"rgba(124,58,237,0.08)",border:"1px solid rgba(124,58,237,0.25)",color:"#c4b5fd",fontSize:11,lineHeight:1.5,overflowX:"auto",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:JSON.stringify(n.args,null,2)})]})}function I({messages:n,streaming:i}){const d=a.useRef(null);return a.useEffect(()=>{d.current?.scrollIntoView({behavior:"smooth"})},[n]),n.length===0?e.jsx("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",color:"#3a3a6a",fontSize:14,padding:24,textAlign:"center",lineHeight:1.7},children:e.jsxs("span",{children:["üí° ‰Ω†Â•ΩÔºÅÊàëÊòØ GainLab AI",e.jsx("br",{}),"ÂêëÊàëÊèêÈóÆÂÖ≥‰∫éÂä†ÂØÜË¥ßÂ∏ÅÂ∏ÇÂú∫ÁöÑÈóÆÈ¢ò"]})}):e.jsxs("div",{style:{flex:1,overflowY:"auto",padding:"12px 12px 4px",display:"flex",flexDirection:"column",gap:8},children:[n.map(t=>e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:t.role==="user"?"flex-end":"flex-start"},children:[t.toolCalls&&t.toolCalls.length>0&&e.jsx("div",{style:{marginBottom:4,maxWidth:"90%"},children:t.toolCalls.map(c=>e.jsx(T,{toolCall:c},c.id))}),t.content&&e.jsx("div",{style:{maxWidth:"85%",padding:"8px 12px",borderRadius:t.role==="user"?"16px 16px 4px 16px":"16px 16px 16px 4px",background:t.role==="user"?"linear-gradient(135deg, #2563eb, #1d4ed8)":"#1a1a35",color:t.role==="user"?"#fff":"#c8c8e8",fontSize:13,lineHeight:1.6,border:t.role==="user"?"none":"1px solid #2a2a4a",wordBreak:"break-word",whiteSpace:"pre-wrap"},children:t.content})]},t.id)),i&&e.jsx("div",{style:{display:"flex",alignItems:"flex-start"},children:e.jsx("div",{style:{padding:"8px 14px",borderRadius:"16px 16px 16px 4px",background:"#1a1a35",border:"1px solid #2a2a4a",color:"#6a6aaa",fontSize:13},children:e.jsx("span",{style:{animation:"pulse 1s infinite"},children:"‚óè‚óè‚óè"})})}),e.jsx("div",{ref:d})]})}function z(n){return n.replace(/<think>[\s\S]*?<\/think>/g,"").trim()}const w=20;async function*_(n){const i=n.length>w?n.slice(n.length-w):n;let d={};try{d=JSON.parse(localStorage.getItem("gainlab-agent")||"{}")}catch{}const t=localStorage.getItem("gainlab-lang")||"zh",c=d.endpoint||R;let s;try{s=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:i,config:{model:d.model,style:d.style,lang:t}})})}catch(y){yield{type:"error",error:`ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•: ${String(y)}`};return}if(!s.ok){yield{type:"error",error:`ÊúçÂä°Âô®ÈîôËØØ: ${s.status} ${s.statusText}`};return}const S=s.body;if(!S){yield{type:"error",error:"ÂìçÂ∫î‰Ωì‰∏∫Á©∫"};return}const l=S.getReader(),x=new TextDecoder;let p="";try{for(;;){const{done:y,value:m}=await l.read();if(y)break;p+=x.decode(m,{stream:!0});const j=p.split(`
`);p=j.pop()??"";for(const o of j){const k=o.trim();if(!k||!k.startsWith("data: "))continue;const v=k.slice(6);if(v==="[DONE]"){yield{type:"done"};return}let u;try{u=JSON.parse(v)}catch{continue}const C=u.type;if(C==="text_delta"){const f=u.text??"",r=z(f);r&&(yield{type:"text_delta",text:r})}else if(C==="tool_call"){const f=u.tool;f&&(yield{type:"tool_call",toolCall:{id:f.id??"",name:f.name??"",args:f.arguments??{}}})}else C==="tool_result"?yield{type:"tool_result",result:u.result,widgetState:u.widgetState}:C==="error"&&(yield{type:"error",error:u.message??"Êú™Áü•ÈîôËØØ"})}}}finally{l.releaseLock()}yield{type:"done"}}function E(){const[n,i]=a.useState([]),[d,t]=a.useState(!1),[c,s]=a.useState(null),S=a.useRef(0),l=a.useCallback(()=>`msg_${++S.current}_${Date.now()}`,[]),x=a.useRef([]),p=a.useRef(null),y=a.useRef(!1),m=a.useCallback(async(o,k)=>{if(y.current||!o.trim())return;const v={id:l(),role:"user",content:o.trim()};i(r=>[...r,v]),x.current=[...x.current,{role:"user",content:o.trim()}];const u=l(),C={id:u,role:"assistant",content:"",toolCalls:[]};i(r=>[...r,C]),y.current=!0,t(!0),s(null),p.current=null;let f="";try{for await(const r of _(x.current))if(r.type==="text_delta"&&r.text)f+=r.text,i(h=>h.map(b=>b.id===u?{...b,content:b.content+(r.text??"")}:b));else if(r.type==="tool_call"&&r.toolCall){const h=r.toolCall;p.current=h,s(h),i(b=>b.map(g=>g.id===u?{...g,toolCalls:[...g.toolCalls??[],h]}:g))}else if(r.type==="tool_result"&&r.result!==void 0)p.current&&k&&k(p.current.name,r.result,r.widgetState),p.current=null,s(null);else{if(r.type==="done")break;if(r.type==="error"){const h=`‚ùå ${r.error??"ËØ∑Ê±ÇÂ§±Ë¥•"}`;f+=(f?`
`:"")+h,i(b=>b.map(g=>g.id===u?{...g,content:g.content+(g.content?`
`:"")+h}:g));break}}}finally{f&&(x.current=[...x.current,{role:"assistant",content:f}]),y.current=!1,t(!1),s(null),p.current=null}},[l]),j=a.useCallback(()=>{i([]),x.current=[]},[]);return{messages:n,streaming:d,activeToolCall:c,sendMessage:m,clearMessages:j}}function $({onToolResult:n,onNewRound:i,onClose:d}){const[t,c]=a.useState(""),s=a.useRef(null),{messages:S,streaming:l,activeToolCall:x,sendMessage:p,clearMessages:y}=E(),m=a.useCallback(async()=>{const o=t.trim();!o||l||(c(""),i?.(),await p(o,n),s.current?.focus())},[t,l,p,n,i]),j=a.useCallback(o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),m())},[m]);return e.jsxs("div",{style:{width:"100%",height:"100%",display:"flex",flexDirection:"column",background:"#0d0d20",borderLeft:"1px solid #1e1e3a",overflow:"hidden"},children:[e.jsxs("div",{style:{padding:"10px 14px",borderBottom:"1px solid #1e1e3a",display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0},children:[e.jsx("span",{style:{color:"#8888cc",fontSize:13,fontWeight:600},children:"‚ú® GainLab AI"}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:4},children:[e.jsx("button",{onClick:y,style:{background:"none",border:"none",color:"#4a4a7a",fontSize:11,cursor:"pointer",padding:"2px 6px",borderRadius:4},title:"Ê∏ÖÁ©∫ÂØπËØù",children:"Ê∏ÖÁ©∫"}),d&&e.jsx("button",{onClick:d,style:{background:"none",border:"none",color:"#4a4a7a",fontSize:14,cursor:"pointer",padding:"2px 6px",borderRadius:4,lineHeight:1},title:"Êî∂Ëµ∑",children:"‚úï"})]})]}),e.jsx(I,{messages:S,streaming:l}),x&&e.jsxs("div",{style:{padding:"4px 12px",background:"rgba(124,58,237,0.1)",borderTop:"1px solid rgba(124,58,237,0.2)",color:"#a78bfa",fontSize:11,flexShrink:0},children:["üîß Ê≠£Âú®Ë∞ÉÁî® ",x.name,"..."]}),e.jsxs("div",{style:{padding:"10px 12px",borderTop:"1px solid #1e1e3a",display:"flex",gap:8,alignItems:"flex-end",flexShrink:0},children:[e.jsx("textarea",{ref:s,value:t,onChange:o=>c(o.target.value),onKeyDown:j,disabled:l,placeholder:l?"Ê≠£Âú®ÂõûÂ§ç‰∏≠...":"ÂèëÊ∂àÊÅØÔºàEnter ÂèëÈÄÅÔºåShift+Enter Êç¢Ë°åÔºâ",rows:1,style:{flex:1,background:"#13132a",border:"1px solid #2a2a4a",borderRadius:8,color:"#d0d0f0",fontSize:13,padding:"8px 10px",resize:"none",outline:"none",fontFamily:"inherit",lineHeight:1.5,maxHeight:120,overflowY:"auto",transition:"border-color 0.15s",opacity:l?.6:1},onFocus:o=>{o.currentTarget.style.borderColor="#4a4a8a"},onBlur:o=>{o.currentTarget.style.borderColor="#2a2a4a"}}),e.jsx("button",{onClick:m,disabled:l||!t.trim(),style:{padding:"8px 14px",borderRadius:8,border:"none",background:l||!t.trim()?"#1e1e3a":"linear-gradient(135deg, #2563eb, #1d4ed8)",color:l||!t.trim()?"#3a3a6a":"#fff",fontSize:13,cursor:l||!t.trim()?"not-allowed":"pointer",flexShrink:0,transition:"all 0.15s",fontFamily:"inherit"},children:"ÂèëÈÄÅ"})]})]})}export{$ as ChatPanel};
