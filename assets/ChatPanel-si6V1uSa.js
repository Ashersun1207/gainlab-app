import{j as e}from"./mosaic-86Umg_jF.js";import{a as p}from"./echarts-DW2iXprX.js";function v({toolCall:l}){const[a,n]=p.useState(!1),r=Object.entries(l.args).slice(0,2).map(([s,x])=>`${s}: ${String(x)}`).join(", ");return e.jsxs("div",{style:{marginTop:4,marginBottom:2},children:[e.jsxs("button",{onClick:()=>n(s=>!s),style:{display:"inline-flex",alignItems:"center",gap:4,padding:"2px 8px",borderRadius:12,border:"1px solid #7c3aed",background:"rgba(124,58,237,0.15)",color:"#c4b5fd",fontSize:11,cursor:"pointer",lineHeight:"1.4",fontFamily:"inherit"},children:[e.jsx("span",{children:"üîß"}),e.jsx("span",{style:{fontWeight:600},children:l.name}),r&&e.jsxs("span",{style:{color:"#a78bfa",opacity:.85},children:["(",r,")"]}),e.jsx("span",{style:{opacity:.6,fontSize:10},children:a?"‚ñ≤":"‚ñº"})]}),a&&e.jsx("pre",{style:{margin:"4px 0 0 4px",padding:"6px 10px",borderRadius:6,background:"rgba(124,58,237,0.08)",border:"1px solid rgba(124,58,237,0.25)",color:"#c4b5fd",fontSize:11,lineHeight:1.5,overflowX:"auto",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:JSON.stringify(l.args,null,2)})]})}function C({messages:l,streaming:a}){const n=p.useRef(null);return p.useEffect(()=>{n.current?.scrollIntoView({behavior:"smooth"})},[l]),l.length===0?e.jsx("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",color:"#3a3a6a",fontSize:14,padding:24,textAlign:"center",lineHeight:1.7},children:e.jsxs("span",{children:["üí° ‰Ω†Â•ΩÔºÅÊàëÊòØ GainLab AI",e.jsx("br",{}),"ÂêëÊàëÊèêÈóÆÂÖ≥‰∫éÂä†ÂØÜË¥ßÂ∏ÅÂ∏ÇÂú∫ÁöÑÈóÆÈ¢ò"]})}):e.jsxs("div",{style:{flex:1,overflowY:"auto",padding:"12px 12px 4px",display:"flex",flexDirection:"column",gap:8},children:[l.map(r=>e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:r.role==="user"?"flex-end":"flex-start"},children:[r.toolCalls&&r.toolCalls.length>0&&e.jsx("div",{style:{marginBottom:4,maxWidth:"90%"},children:r.toolCalls.map(s=>e.jsx(v,{toolCall:s},s.id))}),r.content&&e.jsx("div",{style:{maxWidth:"85%",padding:"8px 12px",borderRadius:r.role==="user"?"16px 16px 4px 16px":"16px 16px 16px 4px",background:r.role==="user"?"linear-gradient(135deg, #2563eb, #1d4ed8)":"#1a1a35",color:r.role==="user"?"#fff":"#c8c8e8",fontSize:13,lineHeight:1.6,border:r.role==="user"?"none":"1px solid #2a2a4a",wordBreak:"break-word",whiteSpace:"pre-wrap"},children:r.content})]},r.id)),a&&e.jsx("div",{style:{display:"flex",alignItems:"flex-start"},children:e.jsx("div",{style:{padding:"8px 14px",borderRadius:"16px 16px 16px 4px",background:"#1a1a35",border:"1px solid #2a2a4a",color:"#6a6aaa",fontSize:13},children:e.jsx("span",{style:{animation:"pulse 1s infinite"},children:"‚óè‚óè‚óè"})})}),e.jsx("div",{ref:n})]})}const w="https://gainlab-api.asher-sun.workers.dev/api/chat";function R(l){return l.replace(/<think>[\s\S]*?<\/think>/g,"").trim()}const k=20;async function*T(l){const a=l.length>k?l.slice(l.length-k):l;let n;try{n=await fetch(w,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:a})})}catch(u){yield{type:"error",error:`ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•: ${String(u)}`};return}if(!n.ok){yield{type:"error",error:`ÊúçÂä°Âô®ÈîôËØØ: ${n.status} ${n.statusText}`};return}const r=n.body;if(!r){yield{type:"error",error:"ÂìçÂ∫î‰Ωì‰∏∫Á©∫"};return}const s=r.getReader(),x=new TextDecoder;let o="";try{for(;;){const{done:u,value:h}=await s.read();if(u)break;o+=x.decode(h,{stream:!0});const b=o.split(`
`);o=b.pop()??"";for(const y of b){const g=y.trim();if(!g||!g.startsWith("data: "))continue;const i=g.slice(6);if(i==="[DONE]"){yield{type:"done"};return}let f;try{f=JSON.parse(i)}catch{continue}const m=f.type;if(m==="text_delta"){const t=f.text??"",d=R(t);d&&(yield{type:"text_delta",text:d})}else if(m==="tool_call"){const t=f.tool;t&&(yield{type:"tool_call",toolCall:{id:t.id??"",name:t.name??"",args:t.arguments??{}}})}else m==="tool_result"?yield{type:"tool_result",result:f.result}:m==="error"&&(yield{type:"error",error:f.message??"Êú™Áü•ÈîôËØØ"})}}}finally{s.releaseLock()}yield{type:"done"}}let z=0;function S(){return`msg_${++z}_${Date.now()}`}function I(){const[l,a]=p.useState([]),[n,r]=p.useState(!1),[s,x]=p.useState(null),o=p.useRef([]),u=p.useRef(null),h=p.useCallback(async(y,g)=>{if(n||!y.trim())return;const i={id:S(),role:"user",content:y.trim()};a(t=>[...t,i]),o.current=[...o.current,{role:"user",content:y.trim()}];const f=S(),m={id:f,role:"assistant",content:"",toolCalls:[]};a(t=>[...t,m]),r(!0),x(null),u.current=null;try{for await(const t of T(o.current))if(t.type==="text_delta"&&t.text)a(d=>d.map(c=>c.id===f?{...c,content:c.content+(t.text??"")}:c));else if(t.type==="tool_call"&&t.toolCall){const d=t.toolCall;u.current=d,x(d),a(c=>c.map(j=>j.id===f?{...j,toolCalls:[...j.toolCalls??[],d]}:j))}else if(t.type==="tool_result"&&t.result!==void 0)u.current&&g&&g(u.current.name,t.result),u.current=null,x(null);else{if(t.type==="done")break;if(t.type==="error"){a(d=>d.map(c=>c.id===f?{...c,content:c.content+(c.content?`
`:"")+`‚ùå ${t.error??"ËØ∑Ê±ÇÂ§±Ë¥•"}`}:c));break}}a(t=>{const d=t.find(c=>c.id===f);return d?.content&&(o.current=[...o.current,{role:"assistant",content:d.content}]),t})}finally{r(!1),x(null),u.current=null}},[n]),b=p.useCallback(()=>{a([]),o.current=[]},[]);return{messages:l,streaming:n,activeToolCall:s,sendMessage:h,clearMessages:b}}function M({onToolResult:l,onClose:a}){const[n,r]=p.useState(""),s=p.useRef(null),{messages:x,streaming:o,activeToolCall:u,sendMessage:h,clearMessages:b}=I(),y=p.useCallback(async()=>{const i=n.trim();!i||o||(r(""),await h(i,l),s.current?.focus())},[n,o,h,l]),g=p.useCallback(i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),y())},[y]);return e.jsxs("div",{style:{width:"100%",height:"100%",display:"flex",flexDirection:"column",background:"#0d0d20",borderLeft:"1px solid #1e1e3a",overflow:"hidden"},children:[e.jsxs("div",{style:{padding:"10px 14px",borderBottom:"1px solid #1e1e3a",display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0},children:[e.jsx("span",{style:{color:"#8888cc",fontSize:13,fontWeight:600},children:"‚ú® GainLab AI"}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:4},children:[e.jsx("button",{onClick:b,style:{background:"none",border:"none",color:"#4a4a7a",fontSize:11,cursor:"pointer",padding:"2px 6px",borderRadius:4},title:"Ê∏ÖÁ©∫ÂØπËØù",children:"Ê∏ÖÁ©∫"}),a&&e.jsx("button",{onClick:a,style:{background:"none",border:"none",color:"#4a4a7a",fontSize:14,cursor:"pointer",padding:"2px 6px",borderRadius:4,lineHeight:1},title:"Êî∂Ëµ∑",children:"‚úï"})]})]}),e.jsx(C,{messages:x,streaming:o}),u&&e.jsxs("div",{style:{padding:"4px 12px",background:"rgba(124,58,237,0.1)",borderTop:"1px solid rgba(124,58,237,0.2)",color:"#a78bfa",fontSize:11,flexShrink:0},children:["üîß Ê≠£Âú®Ë∞ÉÁî® ",u.name,"..."]}),e.jsxs("div",{style:{padding:"10px 12px",borderTop:"1px solid #1e1e3a",display:"flex",gap:8,alignItems:"flex-end",flexShrink:0},children:[e.jsx("textarea",{ref:s,value:n,onChange:i=>r(i.target.value),onKeyDown:g,disabled:o,placeholder:o?"Ê≠£Âú®ÂõûÂ§ç‰∏≠...":"ÂèëÊ∂àÊÅØÔºàEnter ÂèëÈÄÅÔºåShift+Enter Êç¢Ë°åÔºâ",rows:1,style:{flex:1,background:"#13132a",border:"1px solid #2a2a4a",borderRadius:8,color:"#d0d0f0",fontSize:13,padding:"8px 10px",resize:"none",outline:"none",fontFamily:"inherit",lineHeight:1.5,maxHeight:120,overflowY:"auto",transition:"border-color 0.15s",opacity:o?.6:1},onFocus:i=>{i.currentTarget.style.borderColor="#4a4a8a"},onBlur:i=>{i.currentTarget.style.borderColor="#2a2a4a"}}),e.jsx("button",{onClick:y,disabled:o||!n.trim(),style:{padding:"8px 14px",borderRadius:8,border:"none",background:o||!n.trim()?"#1e1e3a":"linear-gradient(135deg, #2563eb, #1d4ed8)",color:o||!n.trim()?"#3a3a6a":"#fff",fontSize:13,cursor:o||!n.trim()?"not-allowed":"pointer",flexShrink:0,transition:"all 0.15s",fontFamily:"inherit"},children:"ÂèëÈÄÅ"})]})]})}export{M as ChatPanel};
